# üîç –ü–†–û–ë–õ–ï–ú–ê –° RING BUFFER –ù–ê–ô–î–ï–ù–ê –ò –†–ï–®–ï–ù–ê

## –î–∞—Ç–∞: 14.11.2024

## üêõ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:

### –°–∏–º–ø—Ç–æ–º—ã:
- Pipeline —Å `tee ‚Üí ring buffer` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ 2-3 –∫–∞–¥—Ä–∞ –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- FPS –ø–∞–¥–∞–µ—Ç –¥–æ 0 –Ω–∞ –æ–±–µ–∏—Ö –≤–µ—Ç–∫–∞—Ö (direct –∏ buffered)
- Ring buffer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, –Ω–æ `transform_ip` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 3 —Ä–∞–∑–∞

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
1. **–° tee**: Pipeline –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ 3 –∫–∞–¥—Ä–æ–≤ ‚ùå
2. **–ë–µ–∑ tee** (standalone): Ring buffer —Ä–∞–±–æ—Ç–∞–µ—Ç –ò–î–ï–ê–õ–¨–ù–û ‚úÖ
   - –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –≤—Å–µ 30/90 –∫–∞–¥—Ä–æ–≤
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "üéØ Buffer filled!"
   - –ù–∞—á–∏–Ω–∞–µ—Ç –≤—ã–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ –∫–∞–¥—Ä—ã
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ 120 –∫–∞–¥—Ä–æ–≤ –¥–æ EOS

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞:
```cpp
// –í transform_ip –≤–æ –≤—Ä–µ–º—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è:
if (self->accumulated < self->size) {
    return GST_BASE_TRANSFORM_FLOW_DROPPED;  // ‚ùå –í–û–¢ –ü–†–û–ë–õ–ï–ú–ê!
}
```

**`tee` —ç–ª–µ–º–µ–Ω—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `FLOW_DROPPED`!**

–ö–æ–≥–¥–∞ ring buffer –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `GST_BASE_TRANSFORM_FLOW_DROPPED`:
- GStreamer `tee` –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç —ç—Ç–æ –∫–∞–∫ "–≤–µ—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞"
- `tee` –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –±—É—Ñ–µ—Ä—ã –≤ —ç—Ç—É –≤–µ—Ç–∫—É
- Upstream —ç–ª–µ–º–µ–Ω—Ç—ã (nvdsstitch, filesrc) —Ç–æ–∂–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
- **–í–µ—Å—å pipeline –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è!**

## ‚úÖ –†–µ—à–µ–Ω–∏–µ:

–í–º–µ—Å—Ç–æ dropping –±—É—Ñ–µ—Ä–æ–≤ –≤–æ –≤—Ä–µ–º—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è - **pass them through**!

### –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞:
```cpp
// –§–∞–∑–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è (frames 0..89):
- –ö–æ–ø–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω–æ–π –∫–∞–¥—Ä –≤ ring buffer ‚úÖ
- –ù–û –¢–ê–ö–ñ–ï –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ –¥–∞–ª—å—à–µ (FLOW_OK) ‚úÖ
- –≠—Ç–æ –¥–µ—Ä–∂–∏—Ç pipeline "–∂–∏–≤—ã–º"

// –§–∞–∑–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ (frames 90+):
- –ö–æ–ø–∏—Ä—É–µ–º –≤—Ö–æ–¥–Ω–æ–π –∫–∞–¥—Ä –≤ ring buffer ‚úÖ
- –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É—Ñ–µ—Ä–∞ –Ω–∞ —Å—Ç–∞—Ä—ã–π –∫–∞–¥—Ä –∏–∑ tail ‚úÖ
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º FLOW_OK ‚úÖ
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
1. ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å `tee` - pipeline –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
2. ‚úÖ –ü—Ä–æ—Å—Ç–æ–π downstream –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —Ä–∞–± –æ—Ç–∞—Ç—å —Å—Ä–∞–∑—É (–∏–ª–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–µ –∫–∞–¥—Ä—ã)
3. ‚úÖ –ù–∏–∫–∞–∫–∏—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç–æ–∫ FLOW_DROPPED –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:

### –ë—ã–ª–æ (–ù–ï –†–ê–ë–û–¢–ê–ï–¢ —Å tee):
```cpp
if (self->accumulated < self->size) {
    // –î—Ä–æ–ø–∞–µ–º –∫–∞–¥—Ä
    g_rec_mutex_unlock (&self->lock);
    gst_buffer_unmap (buf, &map);
    return GST_BASE_TRANSFORM_FLOW_DROPPED;  // ‚ùå
}
```

### –°—Ç–∞–ª–æ (–†–ê–ë–û–¢–ê–ï–¢ —Å tee):
```cpp
if (self->accumulated < self->size) {
    // –ö–∞–¥—Ä —É–∂–µ –≤ ring, –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ –¥–∞–ª—å—à–µ
    g_rec_mutex_unlock (&self->lock);
    gst_buffer_unmap (buf, &map);
    return GST_FLOW_OK;  // ‚úÖ Pass-through
}
```

–ü–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:
```cpp
if (self->delay_complete) {
    // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ buf –Ω–∞ —Å—Ç–∞—Ä—ã–π –∫–∞–¥—Ä –∏–∑ ring
    ring_pop_copy (self, surf);
}
return GST_FLOW_OK;
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
# –¢–µ—Å—Ç 1: Standalone (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ)
python3 test_ringbuf_standalone.py

# –¢–µ—Å—Ç 2: –° tee (—Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å!)
python3 test_tee_ringbuffer.py

# –¢–µ—Å—Ç 3: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ stitch
python3 test_stitch_ringbuffer_full.py
```

## üí° –í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ:

–ü—Ä–∏ pass-through –ø–æ–¥—Ö–æ–¥–µ –ø–µ—Ä–≤—ã–µ –∫–∞–¥—Ä—ã –Ω–∞ buffered –≤–µ—Ç–∫–µ –±—É–¥—É—Ç:
- Frames 0-89: "—Ç–µ–∫—É—â–∏–µ" –∫–∞–¥—Ä—ã (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏) - –º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
- Frames 90+: –∑–∞–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ –∫–∞–¥—Ä—ã (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 3 —Å–µ–∫)

–ï—Å–ª–∏ downstream —Ç—Ä–µ–±—É–µ—Ç "—Ç–æ–ª—å–∫–æ –∑–∞–¥–µ—Ä–∂–∞–Ω–Ω—ã–µ –∫–∞–¥—Ä—ã":
- Option 1: Downstream –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä–≤—ã–µ 90 –∫–∞–¥—Ä–æ–≤
- Option 2: –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –≤ metadata "warmup_phase"

–î–ª—è –Ω–∞—à–µ–≥–æ —Å–ª—É—á–∞—è (virtualcam/panorama display) —ç—Ç–æ –Ω–µ –ø—Ä–æ–±–ª–µ–º–∞ - –ø–µ—Ä–≤—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –±—É–¥—É—Ç –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏, –ø–æ—Ç–æ–º –≤–∫–ª—é—á–∏—Ç—Å—è –∑–∞–¥–µ—Ä–∂–∫–∞.

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ gstnvdsringbuf.cpp
