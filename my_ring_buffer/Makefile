# Makefile –¥–ª—è GStreamer Ring Buffer plugin
# GPU COPY VERSION with CUDA

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
CXX = g++

# –ë–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
CXXFLAGS = -fPIC -Wall -Wextra -O3 -std=c++14 -DPACKAGE=\"nvdsringbuf\"

# –ü—É—Ç–∏ –∫ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–º —Ñ–∞–π–ª–∞–º
INCLUDES = -I. \
           -Isrc \
           -I/opt/nvidia/deepstream/deepstream-7.1/sources/includes \
           -I/usr/local/cuda/include

# GStreamer —Ñ–ª–∞–≥–∏
GST_CFLAGS = $(shell pkg-config --cflags gstreamer-1.0 gstreamer-base-1.0 gstreamer-video-1.0)
GST_LIBS = $(shell pkg-config --libs gstreamer-1.0 gstreamer-base-1.0 gstreamer-video-1.0)

# DeepStream –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–¥–ª—è —Ä–∞–±–æ—Ç—ã —Å NVMM) - –∫–∞–∫ –≤ nvdsstitch
DS_LIBS = -L/opt/nvidia/deepstream/deepstream-7.1/lib \
          -lnvdsgst_meta -lnvds_meta -lnvdsgst_helper -lnvbufsurface -lnvbufsurftransform

# CUDA –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–¥–ª—è GPU‚ÜíGPU –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ EGL interop)
CUDA_LIBS = -L/usr/local/cuda/lib64 -lcudart -lcuda

# –¶–µ–ª–µ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
TARGET = libgstnvdsringbuf.so

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
CPP_SOURCES = src/gstnvdsringbuf.cpp

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
CPP_OBJECTS = $(CPP_SOURCES:.cpp=.o)

# –¶–≤–µ—Ç–æ–≤—ã–µ –∫–æ–¥—ã –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

# –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
all: $(TARGET)
	@echo -e "$(GREEN)‚úì Ring Buffer Plugin build complete!$(NC)"
	@echo -e "$(BLUE)Plugin location: $(PWD)/$(TARGET)$(NC)"
	@echo -e "$(YELLOW)Next steps:$(NC)"
	@echo -e "  1. Run 'make install' to install the plugin"
	@echo -e "  2. Run 'make test' to test basic functionality"
	@echo -e "  3. Use 'GST_PLUGIN_PATH=$$PWD gst-inspect-1.0 ringbuffer' to verify"

# –õ–∏–Ω–∫–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
$(TARGET): $(CPP_OBJECTS)
	@echo -e "$(YELLOW)üîó Linking $(TARGET)...$(NC)"
	$(CXX) -shared -o $@ $^ $(GST_LIBS) $(DS_LIBS) $(CUDA_LIBS)
	@echo -e "$(GREEN)‚úì Library created: $@$(NC)"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è C++ —Ñ–∞–π–ª–æ–≤
src/%.o: src/%.cpp
	@echo -e "$(BLUE)üî® Compiling $<...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) $(GST_CFLAGS) -c $< -o $@

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo -e "$(YELLOW)üßπ Cleaning...$(NC)"
	rm -f $(CPP_OBJECTS) $(TARGET)
	rm -f src/*.o
	@echo -e "$(GREEN)‚úì Clean complete$(NC)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
install: $(TARGET)
	@echo -e "$(YELLOW)üì¶ Installing plugin...$(NC)"
	@mkdir -p ~/.local/share/gstreamer-1.0/plugins/
	@cp $(TARGET) ~/.local/share/gstreamer-1.0/plugins/
	@echo -e "$(GREEN)‚úì Plugin installed to ~/.local/share/gstreamer-1.0/plugins/$(NC)"
	@echo -e "$(BLUE)Run 'gst-inspect-1.0 ringbuffer' to verify$(NC)"

# –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞
uninstall:
	@echo -e "$(YELLOW)üóëÔ∏è  Uninstalling plugin...$(NC)"
	@rm -f ~/.local/share/gstreamer-1.0/plugins/$(TARGET)
	@echo -e "$(GREEN)‚úì Plugin uninstalled$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
inspect: $(TARGET)
	@echo -e "$(BLUE)üîç Inspecting ring buffer plugin...$(NC)"
	GST_PLUGIN_PATH=$(PWD) gst-inspect-1.0 ringbuffer

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ (–ø—Ä–æ—Å—Ç–æ–π passthrough)
test: $(TARGET)
	@echo -e "$(BLUE)üß™ Running test pipeline (passthrough mode)...$(NC)"
	@echo -e "$(YELLOW)This will test that plugin loads correctly$(NC)"
	GST_PLUGIN_PATH=$(PWD) GST_DEBUG=ringbuffer:5 gst-launch-1.0 \
		videotestsrc num-buffers=100 ! \
		video/x-raw,width=1920,height=1080,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! \
		ringbuffer max-buffers=10 delay-seconds=1.0 ! \
		fakesink 2>&1 | grep -E "(ringbuffer|Ring|received)"

# –ü–æ–º–æ—â—å
help:
	@echo -e "$(BLUE)Ring Buffer Plugin Makefile$(NC)"
	@echo -e "$(YELLOW)Available targets:$(NC)"
	@echo -e "  $(GREEN)make$(NC)              - Build the plugin"
	@echo -e "  $(GREEN)make clean$(NC)        - Clean build files"
	@echo -e "  $(GREEN)make install$(NC)      - Install plugin to user directory"
	@echo -e "  $(GREEN)make uninstall$(NC)    - Remove installed plugin"
	@echo -e "  $(GREEN)make inspect$(NC)      - Inspect plugin with gst-inspect"
	@echo -e "  $(GREEN)make test$(NC)         - Run test pipeline"
	@echo -e "  $(GREEN)make help$(NC)         - Show this help"
	@echo ""
	@echo -e "$(BLUE)Configuration:$(NC)"
	@echo -e "  Default max-buffers: 210"
	@echo -e "  Default delay: 7.0 seconds"
	@echo -e "  Supported format: NVMM RGBA only"

.PHONY: all clean install uninstall inspect test help

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(CPP_OBJECTS): src/gstnvdsringbuf.h
