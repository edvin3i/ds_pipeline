#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è/–ø–æ—á–∏–Ω–∫–∏ MP4 —Ñ–∞–π–ª–æ–≤ —Å –Ω–µ–ø–æ–ª–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

if [ $# -eq 0 ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./fix_mp4.sh input.mp4 [output.mp4]"
    echo ""
    echo "–û–ø–∏—Å–∞–Ω–∏–µ:"
    echo "  –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç MP4 —Ñ–∞–π–ª—ã —Å –Ω–µ–ø–æ–ª–Ω—ã–º–∏/–ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏"
    echo "  (moov atom) –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å–∞—é—Ç –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  ./fix_mp4.sh broken.mp4                    # –°–æ–∑–¥–∞—Å—Ç broken_fixed.mp4"
    echo "  ./fix_mp4.sh broken.mp4 repaired.mp4       # –°–æ–∑–¥–∞—Å—Ç repaired.mp4"
    exit 1
fi

INPUT="$1"
OUTPUT="${2:-${INPUT%.mp4}_fixed.mp4}"

if [ ! -f "$INPUT" ]; then
    echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $INPUT"
    exit 1
fi

echo "üîß –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MP4 —Ñ–∞–π–ª–∞"
echo "============================================"
echo "–í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª:  $INPUT"
echo "–í—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: $OUTPUT"
echo ""

echo "[1/3] –ü—Ä–æ–≤–µ—Ä–∫–∞ ffmpeg..."
if ! command -v ffmpeg &> /dev/null; then
    echo "‚ùå ffmpeg –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt install ffmpeg"
    exit 1
fi
echo "‚úÖ ffmpeg –Ω–∞–π–¥–µ–Ω"
echo ""

echo "[2/3] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞..."
echo "   –ú–µ—Ç–æ–¥: –ü–µ—Ä–µ–º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ (–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ –±–µ–∑ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è)"

# –ò—Å–ø–æ–ª—å–∑—É–µ–º ffmpeg –¥–ª—è –ø–µ—Ä–µ–º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
# -i input - –≤—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª
# -c copy - –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ç–æ–∫–∏ –±–µ–∑ –ø–µ—Ä–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
# -movflags +faststart - –ø–æ–º–µ—Å—Ç–∏—Ç—å moov atom –≤ –Ω–∞—á–∞–ª–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
# -map 0 - –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ—Ç–æ–∫–∏

ffmpeg -i "$INPUT" \
    -c copy \
    -movflags +faststart \
    -map 0 \
    -y \
    "$OUTPUT" 2>&1 | grep -E "^(Input|Output|Duration|Stream|frame=)" || true

RESULT=$?

echo ""
echo "[3/3] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞..."

if [ $RESULT -eq 0 ] && [ -f "$OUTPUT" ]; then
    INPUT_SIZE=$(stat -c%s "$INPUT" 2>/dev/null || stat -f%z "$INPUT" 2>/dev/null)
    OUTPUT_SIZE=$(stat -c%s "$OUTPUT" 2>/dev/null || stat -f%z "$OUTPUT" 2>/dev/null)

    INPUT_MB=$((INPUT_SIZE / 1024 / 1024))
    OUTPUT_MB=$((OUTPUT_SIZE / 1024 / 1024))

    echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo ""
    echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
    echo "   –ò—Å—Ö–æ–¥–Ω—ã–π —Ä–∞–∑–º–µ—Ä:  ${INPUT_MB} –ú–ë"
    echo "   –†–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ:     ${OUTPUT_MB} –ú–ë"
    echo ""
    echo "üí° –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏:"
    echo "   vlc \"$OUTPUT\""
    echo "   ffplay \"$OUTPUT\""
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª"
    exit 1
fi

echo ""
echo "============================================"
echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
