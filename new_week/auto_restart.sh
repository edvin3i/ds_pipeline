#!/bin/bash
# auto_restart_safe.sh

echo "üöÄ –ó–∞–ø—É—Å–∫ MASR —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º"
echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"
echo "-----------------------------------------"

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
check_internet() {
    timeout 3 nc -zv a.rtmp.youtube.com 1935 &>/dev/null
    return $?
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫–∞–º–µ—Ä
cleanup_cameras() {
    echo "$(date '+%H:%M:%S'): üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–º–µ—Ä..."
    
    # –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—ã
    pkill -f nvarguscamerasrc 2>/dev/null
    pkill -f version_masr.py 2>/dev/null
    
    # –ñ–¥—ë–º –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è
    sleep 2
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–º–µ—Ä—ã —Å–≤–æ–±–æ–¥–Ω—ã
    if lsof /dev/video* 2>/dev/null | grep -q python; then
        echo "$(date '+%H:%M:%S'): ‚ö†Ô∏è  –§–æ—Ä—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞..."
        pkill -9 -f python3 2>/dev/null
        sleep 2
    fi
    
    echo "$(date '+%H:%M:%S'): ‚úÖ –ö–∞–º–µ—Ä—ã –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω—ã"
}

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
trap 'echo "–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è..."; cleanup_cameras; exit 0' SIGINT SIGTERM

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
while true; do
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
    if ! check_internet; then
        echo "$(date '+%H:%M:%S'): üì° –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞, –æ–∂–∏–¥–∞–Ω–∏–µ..."
        while ! check_internet; do
            sleep 5
        done
        echo "$(date '+%H:%M:%S'): ‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    fi
    
    echo "$(date '+%H:%M:%S'): üé¨ –ó–∞–ø—É—Å–∫ —Å—Ç—Ä–∏–º–∞..."
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º (–Ω–∞ —Å–ª—É—á–∞–π –ø–æ–ª–Ω–æ–≥–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è)
    # --mode  panorama - –æ–±—â–µ–µ –æ–∫–Ω–æ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, virtualcam - —Ä–µ–∂–∏–º –≤–∏—Ä—Ç–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, stream - —Å—Ç—Ä–∏–º –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É
    # --source files - –∏—Å—Ç–æ—á–∏–Ω —Ñ–∞–π–ª—ã, cameras - –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∫–∞–º–µ—Ä—ã
    # --video1 0  - 0 –ª–µ–≤–∞—è –∫–∞–º–µ—Ä–∞ 
    # --video2 1  - 1 –ø—Ä–∞–≤–∞—è –∫–∞–º–µ—Ä–∞
    timeout --preserve-status 3600 python3 version_masr.py \
        --mode stream \
        --stream-url 'rtmp://a.rtmp.youtube.com/live2/' \
        --stream-key 'ufpj-dffk-f1de-8ya6-crq5' \
        --source cameras \
        --video1 0 \
        --video2 1
    
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 124 ]; then
        echo "$(date '+%H:%M:%S'): ‚è±Ô∏è  –¢–∞–π–º–∞—É—Ç (1 —á–∞—Å) - –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫"
    else
        echo "$(date '+%H:%M:%S'): ‚èπÔ∏è  –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Å –∫–æ–¥–æ–º: $EXIT_CODE"
    fi
    
    # –í–°–ï–ì–î–ê –æ—á–∏—â–∞–µ–º –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    cleanup_cameras
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º
    if ! check_internet; then
        echo "$(date '+%H:%M:%S'): üì° –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–æ–ø–∞–ª, –æ–∂–∏–¥–∞–Ω–∏–µ..."
        while ! check_internet; do
            sleep 5
        done
    fi
    
    echo "$(date '+%H:%M:%S'): ‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥..."
    sleep 5
done
