# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞–≥–∏–Ω–∞ nvdsstitch - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–æ–±—â–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø–∞–º—è—Ç—å—é)
3. [EGL Cache –º–µ—Ö–∞–Ω–∏–∑–º](#egl-cache-–º–µ—Ö–∞–Ω–∏–∑–º)
4. [–ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–¥—Ä–∞](#–ø–æ—Ç–æ–∫-–æ–±—Ä–∞–±–æ—Ç–∫–∏-–∫–∞–¥—Ä–∞)
5. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
6. [CUDA –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏](#cuda-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

---

## 1. –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–ª–∞–≥–∏–Ω–∞

```
GstNvdsStitch (–æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç)
‚îú‚îÄ‚îÄ –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –±—É—Ñ–µ—Ä—ã (2 —à—Ç, —Å–æ–∑–¥–∞—é—Ç—Å—è 1 —Ä–∞–∑)
‚îÇ   ‚îú‚îÄ‚îÄ intermediate_left  (GstBuffer + NvBufSurface)
‚îÇ   ‚îî‚îÄ‚îÄ intermediate_right (GstBuffer + NvBufSurface)
‚îÇ
‚îú‚îÄ‚îÄ –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª –≤—ã—Ö–æ–¥–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ (8 —à—Ç)
‚îÇ   ‚îú‚îÄ‚îÄ buffers[8]         (GstBuffer –º–∞—Å—Å–∏–≤)
‚îÇ   ‚îú‚îÄ‚îÄ surfaces[8]        (NvBufSurface –º–∞—Å—Å–∏–≤)
‚îÇ   ‚îú‚îÄ‚îÄ registered[8]      (—Ñ–ª–∞–≥–∏ EGL —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
‚îÇ   ‚îú‚îÄ‚îÄ current_index      (–∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –±—É—Ñ–µ—Ä–∞)
‚îÇ   ‚îî‚îÄ‚îÄ mutex              (–∑–∞—â–∏—Ç–∞ –¥–æ—Å—Ç—É–ø–∞)
‚îÇ
‚îú‚îÄ‚îÄ LUT –∫–∞—Ä—Ç—ã –≤ GPU –ø–∞–º—è—Ç–∏ (–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è 1 —Ä–∞–∑)
‚îÇ   ‚îú‚îÄ‚îÄ warp_left_x_gpu   (6528x1632 floats = 40.64 MB)
‚îÇ   ‚îú‚îÄ‚îÄ warp_left_y_gpu   (6528x1632 floats = 40.64 MB)
‚îÇ   ‚îú‚îÄ‚îÄ warp_right_x_gpu  (6528x1632 floats = 40.64 MB)
‚îÇ   ‚îú‚îÄ‚îÄ warp_right_y_gpu  (6528x1632 floats = 40.64 MB)
‚îÇ   ‚îú‚îÄ‚îÄ weight_left_gpu   (6528x1632 floats = 40.64 MB)
‚îÇ   ‚îî‚îÄ‚îÄ weight_right_gpu  (6528x1632 floats = 40.64 MB)
‚îÇ   –ò–¢–û–ì–û: 243.84 MB GPU –ø–∞–º—è—Ç–∏
‚îÇ
‚îú‚îÄ‚îÄ EGL Resource Cache (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π)
‚îÇ   ‚îú‚îÄ‚îÄ egl_resource_cache (GHashTable)
‚îÇ   ‚îú‚îÄ‚îÄ egl_lock           (GMutex –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
‚îÇ   ‚îî‚îÄ‚îÄ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (hits, misses, registrations)
‚îÇ
‚îî‚îÄ‚îÄ CUDA —Ä–µ—Å—É—Ä—Å—ã
    ‚îú‚îÄ‚îÄ cuda_stream        (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ)
    ‚îî‚îÄ‚îÄ kernel_config      (–ø–∞—Ä–∞–º–µ—Ç—Ä—ã CUDA —è–¥—Ä–∞)
```

### –†–∞–∑–º–µ—Ä—ã –∏ —Ñ–æ—Ä–º–∞—Ç—ã

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- 2 –∫–∞–¥—Ä–∞ –æ—Ç nvstreammux (batch-size=2)
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 3840x2160 RGBA (4K)
- –§–æ—Ä–º–∞—Ç: NVBUF_MEM_SURFACE_ARRAY (GPU –ø–∞–º—è—Ç—å)
- –†–∞–∑–º–µ—Ä –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞: ~32 MB

**–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
- 1 –ø–∞–Ω–æ—Ä–∞–º–Ω—ã–π –∫–∞–¥—Ä
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 6528x1632 RGBA
- –§–æ—Ä–º–∞—Ç: NVBUF_MEM_SURFACE_ARRAY
- –†–∞–∑–º–µ—Ä: ~40.64 MB

---

## 2. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

### 2.1. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –±—É—Ñ–µ—Ä—ã

**–°–æ–∑–¥–∞–Ω–∏–µ** (—Ñ—É–Ω–∫—Ü–∏—è `setup_intermediate_buffer_pool`):

```cpp
// –°–æ–∑–¥–∞—é—Ç—Å—è –î–í–ê –±—É—Ñ–µ—Ä–∞ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:
intermediate_left:  3840x2160 RGBA (~32 MB GPU)
intermediate_right: 3840x2160 RGBA (~32 MB GPU)

–ò–¢–û–ì–û: ~64 MB GPU –ø–∞–º—è—Ç–∏
```

**–ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è:**
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–∞–¥—Ä–µ (lazy initialization)
- –û–¥–∏–Ω —Ä–∞–∑ –∑–∞ –≤–µ—Å—å –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø–ª–∞–≥–∏–Ω–∞

**–ó–∞—á–µ–º –Ω—É–∂–Ω—ã:**
- –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞—Ç—á–∞ nvstreammux
- –†–∞–∑–¥–µ–ª–∏—Ç—å –ª–µ–≤—ã–π –∏ –ø—Ä–∞–≤—ã–π –∫–∞–¥—Ä—ã
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è CUDA

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª:**
```
–°–æ–∑–¥–∞–Ω–∏–µ       ‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ        ‚Üí –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ
(–ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä)    (–∫–∞–∂–¥—ã–π –∫–∞–¥—Ä)         (finalize)
     ‚Üì                 ‚Üì                      ‚Üì
   alloc         NvBufSurfTransform      cudaFree
   map EGL       CUDA processing         free buffers
```

---

### 2.2. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª –≤—ã—Ö–æ–¥–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤

**–†–∞–∑–º–µ—Ä**: 8 –±—É—Ñ–µ—Ä–æ–≤ (FIXED_OUTPUT_POOL_SIZE)

**–°–æ–∑–¥–∞–Ω–∏–µ** (—Ñ—É–Ω–∫—Ü–∏—è `setup_fixed_output_pool`):

```cpp
struct {
    GstBuffer* buffers[8];         // GStreamer –±—É—Ñ–µ—Ä—ã
    NvBufSurface* surfaces[8];     // NVIDIA –±—É—Ñ–µ—Ä—ã
    gboolean registered[8];        // –§–ª–∞–≥–∏ EGL —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    gint current_index;            // –¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å (round-robin)
    GMutex mutex;                  // –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫
} output_pool_fixed;
```

**–†–∞–±–æ—Ç–∞ –ø—É–ª–∞**:

```
–ö–∞–¥—Ä N:   –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä[0]
–ö–∞–¥—Ä N+1: –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä[1]
–ö–∞–¥—Ä N+2: –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä[2]
...
–ö–∞–¥—Ä N+7: –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä[7]
–ö–∞–¥—Ä N+8: –∏—Å–ø–æ–ª—å–∑—É–µ–º –±—É—Ñ–µ—Ä[0]  ‚Üê –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–∞—á–∞–ª—É (round-robin)
```

**–ó–∞—á–µ–º 8 –±—É—Ñ–µ—Ä–æ–≤?**
1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å**: GStreamer –º–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å –±—É—Ñ–µ—Ä—ã –≤ pipeline
2. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º**: GPU –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–¥—Ä N, –ø–æ–∫–∞ CPU –≥–æ—Ç–æ–≤–∏—Ç –∫–∞–¥—Ä N+1
3. **–ò–∑–±–µ–∂–∞–Ω–∏–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–º—è—Ç—å –≤–º–µ—Å—Ç–æ –∞–ª–ª–æ–∫–∞—Ü–∏–∏

**–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
```cpp
g_mutex_lock(&stitch->output_pool_fixed.mutex);
gint buf_idx = stitch->output_pool_fixed.current_index;
GstBuffer *pool_buf = stitch->output_pool_fixed.buffers[buf_idx];
stitch->output_pool_fixed.current_index = (buf_idx + 1) % 8;
g_mutex_unlock(&stitch->output_pool_fixed.mutex);
```

---

### 2.3. GPU –ø–∞–º—è—Ç—å –¥–ª—è LUT –∫–∞—Ä—Ç

**–ó–∞–≥—Ä—É–∑–∫–∞** (—Ñ—É–Ω–∫—Ü–∏—è `load_panorama_luts`):

```cpp
// –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –û–î–ò–ù –†–ê–ó –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤:
warp_maps/
‚îú‚îÄ‚îÄ lut_left_x.bin     ‚Üí warp_left_x_gpu   (40.64 MB)
‚îú‚îÄ‚îÄ lut_left_y.bin     ‚Üí warp_left_y_gpu   (40.64 MB)
‚îú‚îÄ‚îÄ lut_right_x.bin    ‚Üí warp_right_x_gpu  (40.64 MB)
‚îú‚îÄ‚îÄ lut_right_y.bin    ‚Üí warp_right_y_gpu  (40.64 MB)
‚îú‚îÄ‚îÄ weight_left.bin    ‚Üí weight_left_gpu   (40.64 MB)
‚îî‚îÄ‚îÄ weight_right.bin   ‚Üí weight_right_gpu  (40.64 MB)
```

**–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏**:
```
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6528 * 1632 * 4 = 42597376 bytes)
2. –ß—Ç–µ–Ω–∏–µ –≤ CPU –ø–∞–º—è—Ç—å (std::vector<float>)
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ NaN/Inf –∑–Ω–∞—á–µ–Ω–∏–π
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: -1000..10000, –≤–µ—Å–∞: 0..1)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
4. cudaMalloc –Ω–∞ GPU
5. cudaMemcpy HOST‚ÜíDEVICE
6. –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ CPU –ø–∞–º—è—Ç–∏
```

**–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª**:
```
–ó–∞–≥—Ä—É–∑–∫–∞        ‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ            ‚Üí –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ
(–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)   (–∫–∞–∂–¥—ã–π –∫–∞–¥—Ä, read-only)   (finalize)
     ‚Üì                     ‚Üì                        ‚Üì
cudaMalloc          CUDA kernel reads         cudaFree
cudaMemcpy          (—á–µ—Ä–µ–∑ __ldg –∏–ª–∏
                     global memory)
```

**–í–∞–∂–Ω–æ**: LUT –∫–∞—Ä—Ç—ã **read-only** –≤ runtime - –∏–∑–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–∞–ª–∏–±—Ä–æ–≤–∫–µ –∫–∞–º–µ—Ä.

---

## 3. EGL Cache –º–µ—Ö–∞–Ω–∏–∑–º

### 3.1. –ß—Ç–æ —Ç–∞–∫–æ–µ EGL –∏ –∑–∞—á–µ–º –Ω—É–∂–µ–Ω –∫—ç—à?

**EGL** (Embedded-System Graphics Library) - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ–∂–¥—É CUDA –∏ GPU –±—É—Ñ–µ—Ä–∞–º–∏.

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ –∫—ç—à–∞**:
```cpp
// –ú–ï–î–õ–ï–ù–ù–û! –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–Ω–∏–º–∞–µ—Ç ~1-2ms
cuGraphicsEGLRegisterImage(&resource, egl_image, flags);
cuGraphicsResourceGetMappedEglFrame(&resource, &frame, 0, 0);
```

**–†–µ—à–µ–Ω–∏–µ - –∫—ç—à**:
```cpp
// –ë–´–°–¢–†–û! –ü–æ–∏—Å–∫ –≤ —Ö—ç—à-—Ç–∞–±–ª–∏—Ü–µ ~0.01ms
cache_entry = g_hash_table_lookup(egl_resource_cache, &key);
if (cache_entry) {  // Cache HIT!
    *resource = cache_entry->cuda_resource;
    *frame = cache_entry->egl_frame;
    return TRUE;  // –ì–æ—Ç–æ–≤–æ –∑–∞ –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã!
}
```

---

### 3.2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫—ç—à–∞

**–ö–ª—é—á –∫—ç—à–∞**:
```cpp
typedef struct {
    gpointer egl_image;    // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ EGL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    gboolean is_write;     // –†–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞ (read/write)
} EGLCacheKey;
```

**–ó–Ω–∞—á–µ–Ω–∏–µ –∫—ç—à–∞**:
```cpp
typedef struct {
    gpointer egl_image;              // EGL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    CUgraphicsResource cuda_resource; // CUDA —Ä–µ—Å—É—Ä—Å (handle)
    CUeglFrame egl_frame;            // –î–∞–Ω–Ω—ã–µ –∫–∞–¥—Ä–∞ (–∞–¥—Ä–µ—Å–∞, pitch)
    gboolean registered;             // –§–ª–∞–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    guint64 last_access_frame;       // –ö–æ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è
} EGLResourceCacheEntry;
```

**–•—Ä–∞–Ω–∏–ª–∏—â–µ**:
```cpp
GHashTable *egl_resource_cache;  // –•—ç—à-—Ç–∞–±–ª–∏—Ü–∞
GMutex egl_lock;                 // –ú—å—é—Ç–µ–∫—Å –¥–ª—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
```

---

### 3.3. –†–∞–±–æ—Ç–∞ –∫—ç—à–∞

#### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞ (—Ñ—É–Ω–∫—Ü–∏—è `get_or_register_egl_resource`):

```cpp
–ü–û–¢–û–ö:

1. –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á: { egl_image, is_write }

2. –ó–∞—Ö–≤–∞—Ç–∏—Ç—å –º—å—é—Ç–µ–∫—Å:
   g_mutex_lock(&stitch->egl_lock)

3. –ü–æ–∏—Å–∫ –≤ –∫—ç—à–µ:
   cache_entry = g_hash_table_lookup(egl_resource_cache, &key)

4. CACHE HIT (–Ω–∞–π–¥–µ–Ω–æ):
   ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å last_access_frame = current_frame
   ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å cuda_resource –∏ egl_frame
   ‚úÖ stitch->egl_cache_hits++
   ‚úÖ g_mutex_unlock(&stitch->egl_lock)
   ‚úÖ return TRUE  // –ë–´–°–¢–†–û!

5. CACHE MISS (–Ω–µ –Ω–∞–π–¥–µ–Ω–æ):
   ‚ùå –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
   ‚ùå cuGraphicsEGLRegisterImage(...)  // –ú–ï–î–õ–ï–ù–ù–û (~1-2ms)
   ‚ùå cuGraphicsResourceGetMappedEglFrame(...)
   ‚ùå –î–æ–±–∞–≤–∏—Ç—å –≤ –∫—ç—à: g_hash_table_insert(...)
   ‚ùå stitch->egl_register_count++
   ‚ùå g_mutex_unlock(&stitch->egl_lock)
   ‚ùå return TRUE  // –ú–ï–î–õ–ï–ù–ù–û, –Ω–æ –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –±—É–¥–µ—Ç –±—ã—Å—Ç—Ä–æ
```

#### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞:

```cpp
stitch->egl_cache_hits;       // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –Ω–∞—à–ª–∏ –≤ –∫—ç—à–µ
stitch->egl_register_count;   // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏ –Ω–æ–≤—ã–µ
stitch->egl_map_count;        // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –º–∞–ø–∏–ª–∏ EGL

// –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫—ç—à–∞:
hit_rate = egl_cache_hits / (egl_cache_hits + egl_register_count)

// –•–æ—Ä–æ—à–∏–π hit rate: > 95%
// –ü–ª–æ—Ö–æ–π hit rate: < 80% (–≤–æ–∑–º–æ–∂–Ω–æ, –∫—ç—à —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π)
```

---

### 3.4. –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ (Garbage Collection)

**–ö–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
- –ö–∞–∂–¥—ã–µ `CACHE_CLEANUP_INTERVAL = 150` –∫–∞–¥—Ä–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —Ñ–æ–Ω–µ

**–ê–ª–≥–æ—Ä–∏—Ç–º** (—Ñ—É–Ω–∫—Ü–∏—è `cleanup_egl_cache`):

```cpp
1. –ü—Ä–æ–π—Ç–∏ –ø–æ –≤—Å–µ–º –∑–∞–ø–∏—Å—è–º –≤ –∫—ç—à–µ

2. –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏:
   frames_since_use = current_frame - entry->last_access_frame

   TTL = (cache_size > MAX_SIZE) ? 50 : 300 –∫–∞–¥—Ä–æ–≤

   if (frames_since_use > TTL) {
       // –ó–∞–ø–∏—Å—å –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –¥–∞–≤–Ω–æ - —É–¥–∞–ª–∏—Ç—å!
       cuGraphicsUnregisterResource(entry->cuda_resource)
       g_hash_table_remove(...)
   }

3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
```cpp
CACHE_CLEANUP_INTERVAL = 150  // –ß–∏—Å—Ç–∏—Ç—å –∫–∞–∂–¥—ã–µ 150 –∫–∞–¥—Ä–æ–≤
CACHE_ENTRY_TTL = 300         // –ñ–∏—Ç—å 300 –∫–∞–¥—Ä–æ–≤ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
CACHE_MAX_SIZE = 50           // –ú–∞–∫—Å–∏–º—É–º 50 –∑–∞–ø–∏—Å–µ–π

// –ï—Å–ª–∏ –∫—ç—à –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω (>50 –∑–∞–ø–∏—Å–µ–π):
// TTL —Å–Ω–∏–∂–∞–µ—Ç—Å—è –¥–æ 50 –∫–∞–¥—Ä–æ–≤ (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞)
```

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–∞ –æ—á–∏—Å—Ç–∫–∞**:
- –ë–µ–∑ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à —Ä–∞—Å—Ç—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ ‚Üí —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏
- –° –æ—á–∏—Å—Ç–∫–æ–π: –∫—ç—à —Å—Ç–∞–±–∏–ª–µ–Ω, –ø–∞–º—è—Ç—å –Ω–µ —É—Ç–µ–∫–∞–µ—Ç

---

### 3.5. –¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

**–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 8 –≤—ã—Ö–æ–¥–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤**:

```
–ö–∞–¥—Ä 1:
  - 2 –≤—Ö–æ–¥–Ω—ã—Ö EGL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (left, right) ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (MISS)
  - 1 –≤—ã—Ö–æ–¥–Ω–æ–µ EGL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (buf[0])     ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (MISS)
  –ò–¢–û–ì–û: 3 —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

–ö–∞–¥—Ä 2:
  - 2 –≤—Ö–æ–¥–Ω—ã—Ö (left, right) ‚Üí CACHE HIT ‚úÖ
  - 1 –≤—ã—Ö–æ–¥–Ω–æ–µ (buf[1])     ‚Üí —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (MISS)
  –ò–¢–û–ì–û: 2 HIT, 1 MISS

–ö–∞–¥—Ä 3:
  - 2 –≤—Ö–æ–¥–Ω—ã—Ö ‚Üí HIT ‚úÖ
  - 1 –≤—ã—Ö–æ–¥–Ω–æ–µ (buf[2]) ‚Üí MISS
  –ò–¢–û–ì–û: 2 HIT, 1 MISS

...

–ö–∞–¥—Ä 8:
  - 2 –≤—Ö–æ–¥–Ω—ã—Ö ‚Üí HIT ‚úÖ
  - 1 –≤—ã—Ö–æ–¥–Ω–æ–µ (buf[7]) ‚Üí MISS
  –ò–¢–û–ì–û: 2 HIT, 1 MISS

–ö–∞–¥—Ä 9:
  - 2 –≤—Ö–æ–¥–Ω—ã—Ö ‚Üí HIT ‚úÖ
  - 1 –≤—ã—Ö–æ–¥–Ω–æ–µ (buf[0]) ‚Üí HIT ‚úÖ  ‚Üê –£–∂–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏ –≤ –∫–∞–¥—Ä–µ 1!
  –ò–¢–û–ì–û: 3 HIT ‚úÖ‚úÖ‚úÖ

–ö–∞–¥—Ä 10+:
  –í–°–ï HIT! 3/3 ‚úÖ‚úÖ‚úÖ

Hit rate –ø–æ—Å–ª–µ 10 –∫–∞–¥—Ä–æ–≤: ~70%
Hit rate –ø–æ—Å–ª–µ 100 –∫–∞–¥—Ä–æ–≤: ~97%
Hit rate —Å—Ç–∞–±–∏–ª—å–Ω–æ: ~99%
```

---

## 4. –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–¥—Ä–∞

### 4.1. –ü–æ–ª–Ω—ã–π pipeline

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. –ü–û–õ–£–ß–ï–ù–ò–ï –í–•–û–î–ù–û–ì–û –ë–£–§–ï–†–ê                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ nvstreammux ‚Üí gst_buffer (batch-size=2)                     ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ source_id=0 (left camera)  3840x2160 RGBA            ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ source_id=1 (right camera) 3840x2160 RGBA            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. –ú–ê–ü–ò–ù–ì –ò –ü–†–û–í–ï–†–ö–ò                                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ gst_buffer_map(inbuf, &in_map, GST_MAP_READ)                ‚îÇ
‚îÇ input_surface = (NvBufSurface*)in_map.data                  ‚îÇ
‚îÇ CHECK_NULL(input_surface)  ‚Üê –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚úÖ              ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ if (input_surface->numFilled != 2)                          ‚îÇ
‚îÇ     return GST_FLOW_OK  // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–π –±–∞—Ç—á        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. –ü–û–ò–°–ö –ò–ù–î–ï–ö–°–û–í –ö–ê–î–†–û–í                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ batch_meta = gst_buffer_get_nvds_batch_meta(inbuf)         ‚îÇ
‚îÇ find_frame_indices(batch_meta, &indices)                    ‚îÇ
‚îÇ   ‚Üí indices.left_index  = 0                                 ‚îÇ
‚îÇ   ‚Üí indices.right_index = 1                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –í –ü–†–û–ú–ï–ñ–£–¢–û–ß–ù–´–ï –ë–£–§–ï–†–´                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ copy_to_intermediate_buffers(input_surface, &indices)       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ NvBufSurfTransform:                                          ‚îÇ
‚îÇ   input_surface->surfaceList[0] ‚Üí intermediate_left  (GPU)  ‚îÇ
‚îÇ   input_surface->surfaceList[1] ‚Üí intermediate_right (GPU)  ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:                                                  ‚îÇ
‚îÇ   transform_flag = NVBUFSURF_TRANSFORM_FILTER              ‚îÇ
‚îÇ   transform_filter = NvBufSurfTransformInter_Default       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ –í—Ä–µ–º—è: ~1-2ms (GPU DMA –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. –ü–û–õ–£–ß–ï–ù–ò–ï –í–´–•–û–î–ù–û–ì–û –ë–£–§–ï–†–ê –ò–ó –ü–£–õ–ê                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ g_mutex_lock(&output_pool_fixed.mutex)                      ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ buf_idx = output_pool_fixed.current_index  // 0..7          ‚îÇ
‚îÇ pool_buf = output_pool_fixed.buffers[buf_idx]               ‚îÇ
‚îÇ output_surface = output_pool_fixed.surfaces[buf_idx]        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ CHECK_NULL(pool_buf && output_surface)  ‚Üê –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚úÖ ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ output_pool_fixed.current_index = (buf_idx + 1) % 8         ‚îÇ
‚îÇ g_mutex_unlock(&output_pool_fixed.mutex)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. EGL MAPPING –ò CUDA –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ #ifdef __aarch64__  // –¢–æ–ª—å–∫–æ –¥–ª—è Jetson!                  ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ –õ–µ–≤—ã–π –∫–∞–¥—Ä:                                                 ‚îÇ
‚îÇ   egl_image = intermediate_left_surf->surfaceList[0].       ‚îÇ
‚îÇ               mappedAddr.eglImage                           ‚îÇ
‚îÇ   get_or_register_egl_resource(egl_image, FALSE,            ‚îÇ
‚îÇ                                &resource, &frame)           ‚îÇ
‚îÇ   ‚Üí –ü–æ–∏—Å–∫ –≤ –∫—ç—à–µ (–æ–±—ã—á–Ω–æ HIT ‚úÖ)                            ‚îÇ
‚îÇ   ‚Üí left_cuda_ptr = frame.frame.pPitch[0]                   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ –ü—Ä–∞–≤—ã–π –∫–∞–¥—Ä:                                                ‚îÇ
‚îÇ   egl_image = intermediate_right_surf->surfaceList[0].      ‚îÇ
‚îÇ               mappedAddr.eglImage                           ‚îÇ
‚îÇ   get_or_register_egl_resource(...)                         ‚îÇ
‚îÇ   ‚Üí right_cuda_ptr = frame.frame.pPitch[0]                  ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ –í—ã—Ö–æ–¥–Ω–æ–π –±—É—Ñ–µ—Ä:                                             ‚îÇ
‚îÇ   egl_image = output_surface->surfaceList[0].               ‚îÇ
‚îÇ               mappedAddr.eglImage                           ‚îÇ
‚îÇ   get_or_register_egl_resource(..., TRUE)  // WRITE mode    ‚îÇ
‚îÇ   ‚Üí output_cuda_ptr = frame.frame.pPitch[0]                 ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ –í—Ä–µ–º—è: ~0.01ms –ø—Ä–∏ cache HIT, ~3-5ms –ø—Ä–∏ MISS              ‚îÇ
‚îÇ #endif                                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 7. –ó–ê–ü–£–°–ö CUDA –Ø–î–†–ê –°–¢–ò–ß–ò–ù–ì–ê                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ err = launch_panorama_kernel(                               ‚îÇ
‚îÇ     left_cuda_ptr,          // –í—Ö–æ–¥: –ª–µ–≤—ã–π –∫–∞–¥—Ä             ‚îÇ
‚îÇ     right_cuda_ptr,         // –í—Ö–æ–¥: –ø—Ä–∞–≤—ã–π –∫–∞–¥—Ä            ‚îÇ
‚îÇ     output_cuda_ptr,        // –í—ã—Ö–æ–¥: –ø–∞–Ω–æ—Ä–∞–º–∞              ‚îÇ
‚îÇ     warp_left_x_gpu,        // LUT: X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ª–µ–≤–æ–π      ‚îÇ
‚îÇ     warp_left_y_gpu,        // LUT: Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ª–µ–≤–æ–π      ‚îÇ
‚îÇ     warp_right_x_gpu,       // LUT: X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∞–≤–æ–π     ‚îÇ
‚îÇ     warp_right_y_gpu,       // LUT: Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∞–≤–æ–π     ‚îÇ
‚îÇ     weight_left_gpu,        // –í–µ—Å–∞ —Å–º–µ—à–∏–≤–∞–Ω–∏—è –ª–µ–≤–æ–π        ‚îÇ
‚îÇ     weight_right_gpu,       // –í–µ—Å–∞ —Å–º–µ—à–∏–≤–∞–Ω–∏—è –ø—Ä–∞–≤–æ–π       ‚îÇ
‚îÇ     &kernel_config,         // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã (—Ä–∞–∑–º–µ—Ä—ã, pitch)   ‚îÇ
‚îÇ     cuda_stream             // CUDA stream –¥–ª—è async        ‚îÇ
‚îÇ )                                                            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ CUDA kernel –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:                                      ‚îÇ
‚îÇ   - –†–∞–∑–º–µ—Ä –±–ª–æ–∫–∞: 32x8 = 256 –ø–æ—Ç–æ–∫–æ–≤                       ‚îÇ
‚îÇ   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤: 408x204 = 83,232 –±–ª–æ–∫–æ–≤             ‚îÇ
‚îÇ   - –í—Å–µ–≥–æ –ø–æ—Ç–æ–∫–æ–≤: 21,307,392                               ‚îÇ
‚îÇ   - –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~17.5ms                               ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ if (err != cudaSuccess) {                                   ‚îÇ
‚îÇ     reset_cuda_state(stitch)  ‚Üê –ù–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ ‚úÖ            ‚îÇ
‚îÇ     return FALSE                                            ‚îÇ
‚îÇ }                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 8. –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ò –í–´–î–ê–ß–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ cudaStreamSynchronize(cuda_stream)  // –ñ–¥—ë–º GPU             ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ gst_buffer_unmap(inbuf, &in_map)                            ‚îÇ
‚îÇ gst_buffer_unref(inbuf)                                     ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ return GST_FLOW_OK ‚Üí output_buf                             ‚îÇ
‚îÇ   (output_buf –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –¥–∞–ª—å—à–µ –ø–æ pipeline)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 4.2. –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞

```
CPU Thread                  GPU
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                  ‚îÄ‚îÄ‚îÄ

Map input (0.1ms)
Find indices (0.1ms)

Copy to intermediate ‚îÄ‚îÄ‚Üí   NvBufSurfTransform (1-2ms)
  (–∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞ GPU)

Lock output pool (0.01ms)
EGL mapping (0.01ms HIT)

Launch CUDA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí    panorama_lut_kernel
  kernel (0.1ms)              ‚îú‚îÄ –ß—Ç–µ–Ω–∏–µ LUT –∏–∑ global memory
                              ‚îú‚îÄ –ë–∏–ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
                              ‚îú‚îÄ –°–º–µ—à–∏–≤–∞–Ω–∏–µ —Å –≤–µ—Å–∞–º–∏
                              ‚îî‚îÄ –ó–∞–ø–∏—Å—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                           (17.5ms)

Wait GPU ‚Üê‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   –ì–æ—Ç–æ–≤–æ!
  (17.5ms)

Unmap, return (0.1ms)

–ò–¢–û–ì–û: ~20ms –Ω–∞ –∫–∞–¥—Ä
FPS: ~44-48
```

---

## 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 5.1. –¢–∏–ø—ã –æ—à–∏–±–æ–∫

**1. CUDA –æ—à–∏–±–∫–∏** (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ):
```cpp
cudaError_t err = launch_panorama_kernel(...);

if (err != cudaSuccess) {
    LOG_ERROR(stitch, "CUDA kernel failed: %s",
              cudaGetErrorString(err));
    reset_cuda_state(stitch);  // ‚úÖ –ù–û–í–û–ï!
    return FALSE;
}
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `reset_cuda_state()`**:
```cpp
static void reset_cuda_state(GstNvdsStitch *stitch) {
    // 1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å stream (–æ—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥)
    if (stitch->cuda_stream) {
        cudaStreamSynchronize(stitch->cuda_stream);
    }

    // 2. –û—á–∏—Å—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—à–∏–±–∫—É CUDA
    cudaGetLastError();  // –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç error state

    LOG_DEBUG(stitch, "CUDA state reset");
}
```

**–ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ**:
- –ë–µ–∑ –æ—á–∏—Å—Ç–∫–∏: CUDA stream –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –æ—à–∏–±–æ—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- –°–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã CUDA –±—É–¥—É—Ç –ø–∞–¥–∞—Ç—å —Å —Ç–æ–π –∂–µ –æ—à–∏–±–∫–æ–π
- –° –æ—á–∏—Å—Ç–∫–æ–π: GPU –º–æ–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä

---

**2. NULL —É–∫–∞–∑–∞—Ç–µ–ª–∏** (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ):
```cpp
NvBufSurface *input_surface = (NvBufSurface *)in_map.data;
CHECK_NULL_RET_FLOW(input_surface, stitch, "input_surface from map");
// ‚Üì –†–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤:
if (!input_surface) {
    LOG_ERROR(stitch, "NULL pointer: input_surface from map");
    return GST_FLOW_ERROR;
}
```

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —É–∫–∞–∑–∞—Ç–µ–ª–∏**:
- `input_surface` - –ø–æ—Å–ª–µ gst_buffer_map
- `pool_buf` - –∏–∑ output pool
- `output_surface` - –∏–∑ output pool
- `batch_meta` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±–∞—Ç—á–∞

---

**3. –ù–µ–ø–æ–ª–Ω—ã–π –±–∞—Ç—á** (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ):
```cpp
if (input_surface->numFilled != 2) {
    LOG_WARNING(stitch, "Incomplete batch: expected 2, got %d",
                input_surface->numFilled);
    // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
    gst_buffer_unmap(inbuf, &in_map);
    gst_buffer_unref(inbuf);
    return GST_FLOW_OK;  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–¥—Ä, –Ω–æ –ù–ï –ø–∞–¥–∞–µ–º
}
```

---

**4. EGL mapping –æ—à–∏–±–∫–∏** (—Å—Ä–µ–¥–Ω–µ–π –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏):
```cpp
if (NvBufSurfaceMapEglImage(surface, -1) != 0) {
    LOG_ERROR(stitch, "Failed to map EGL");
    // TODO: –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—á–∏—Å—Ç–∫—É —Ä–µ—Å—É—Ä—Å–æ–≤
    return FALSE;
}
```

---

### 5.2. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

**–£—Ä–æ–≤–µ–Ω—å 1: –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–∞–¥—Ä**
```cpp
// –ü—Ä–∏ –Ω–µ–ø–æ–ª–Ω–æ–º –±–∞—Ç—á–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
return GST_FLOW_OK;  // –°–∏–≥–Ω–∞–ª GStreamer: –≤—Å—ë –û–ö, –Ω–æ –∫–∞–¥—Ä–∞ –Ω–µ—Ç
```

**–£—Ä–æ–≤–µ–Ω—å 2: –û—á–∏—Å—Ç–∏—Ç—å CUDA –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞**
```cpp
// –ü—Ä–∏ CUDA –æ—à–∏–±–∫–µ
reset_cuda_state(stitch);
return FALSE;  // –°–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å–ø–µ—à–Ω—ã–º
```

**–£—Ä–æ–≤–µ–Ω—å 3: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pipeline**
```cpp
// –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ (NULL —É–∫–∞–∑–∞—Ç–µ–ª–∏)
return GST_FLOW_ERROR;  // GStreamer –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
```

---

### 5.3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–æ–≤**:
```cpp
LOG_ERROR   - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ (–∫—Ä–∞—Å–Ω—ã–π)
LOG_WARNING - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–∂—ë–ª—Ç—ã–π)
LOG_INFO    - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Å–∏–Ω–∏–π)
LOG_DEBUG   - –û—Ç–ª–∞–¥–∫–∞ (—Å–µ—Ä—ã–π)
```

**–ß—Ç–æ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è**:
- –í—Å–µ –æ—à–∏–±–∫–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (–∫–∞–∫–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–∞–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
- –ö–∞–∂–¥—ã–µ 300 –∫–∞–¥—Ä–æ–≤ - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ (—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π —É–¥–∞–ª–µ–Ω–æ)
- –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ**:
```
0:00:10.123 ERROR nvdsstitch ‚ùå CUDA kernel failed: invalid argument
0:00:10.124 DEBUG nvdsstitch üîç CUDA state reset
0:00:10.125 ERROR nvdsstitch ‚ùå NULL pointer: pool_buf
```

---

## 6. CUDA –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 6.1. –†–∞–∑–º–µ—Ä –±–ª–æ–∫–æ–≤ (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø!)

**–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (–≤ `nvdsstitch_config.h`):
```cpp
constexpr int BLOCK_SIZE_X = 32;  // ‚Üê –û–ø—Ç–∏–º–∞–ª—å–Ω–æ!
constexpr int BLOCK_SIZE_Y = 8;   // ‚Üê –û–ø—Ç–∏–º–∞–ª—å–Ω–æ!

// –†–∞–∑–º–µ—Ä –±–ª–æ–∫–∞: 32x8 = 256 –ø–æ—Ç–æ–∫–æ–≤
```

**–ü–æ—á–µ–º—É 32x8 –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ**:

1. **Memory Coalescing**:
   - 32 –ø–æ—Ç–æ–∫–∞ –≤ —à–∏—Ä–∏–Ω—É = 1 warp (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–∞ GPU)
   - –í—Å–µ –ø–æ—Ç–æ–∫–∏ warp —á–∏—Ç–∞—é—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –ø–∞–º—è—Ç–∏
   - GPU –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç 32 —á—Ç–µ–Ω–∏—è –≤ 1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é ‚Üí **–≤ 32 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ!**

2. **Occupancy**:
   - 256 –ø–æ—Ç–æ–∫–æ–≤ = 8 warps –Ω–∞ –±–ª–æ–∫
   - Jetson Orin: 8 SM √ó 64 warps = 512 –∞–∫—Ç–∏–≤–Ω—ã—Ö warps
   - 256 –ø–æ—Ç–æ–∫–æ–≤/–±–ª–æ–∫ = –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ SM

3. **–ú–µ–Ω—å—à–µ Divergence**:
   - 8 —Å—Ç—Ä–æ–∫ –Ω–∞ –±–ª–æ–∫ = –º–µ–Ω—å—à–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è if statements
   - –ü–æ—Ç–æ–∫–∏ –≤–Ω—É—Ç—Ä–∏ warp —á–∞—â–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–æ–¥

**–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**:
- –ë—ã–ª–æ (32x16): 37.20 FPS
- –°—Ç–∞–ª–æ (32x8): **44.43 FPS**
- –£–ª—É—á—à–µ–Ω–∏–µ: **+19.4%**

---

### 6.2. –§–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ CUDA

**–í Makefile**:
```makefile
NVCCFLAGS = -m64 -Xcompiler -fPIC -Xcompiler -fvisibility=hidden
NVCCFLAGS += -gencode arch=compute_87,code=sm_87  # Orin architecture
NVCCFLAGS += -O3                # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
NVCCFLAGS += -use_fast_math     # –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏
NVCCFLAGS += --expt-relaxed-constexpr  # Constexpr –≤ device code
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç `-use_fast_math`**:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `fma` (fused multiply-add)
- –ú–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–µ, –Ω–æ –±—ã—Å—Ç—Ä—ã–µ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `__float2int_rd()` –≤–º–µ—Å—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–∏

---

### 6.3. Kernel launch –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

**–†–∞–∑–º–µ—Ä grid**:
```cpp
dim3 block(32, 8);  // 32x8 = 256 –ø–æ—Ç–æ–∫–æ–≤ –Ω–∞ –±–ª–æ–∫

dim3 grid(
    (output_width + block.x - 1) / block.x,  // = (6528+31)/32 = 204
    (output_height + block.y - 1) / block.y   // = (1632+7)/8 = 204
);
// grid = 204x204 = 41,616 –±–ª–æ–∫–æ–≤
// –í—Å–µ–≥–æ –ø–æ—Ç–æ–∫–æ–≤: 41,616 √ó 256 = 10,653,696 –ø–æ—Ç–æ–∫–æ–≤

panorama_lut_kernel<<<grid, block, 0, cuda_stream>>>(...);
```

---

### 6.4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

**CUDA Stream**:
```cpp
cudaStream_t cuda_stream;
cudaStreamCreate(&cuda_stream);

// –ó–∞–ø—É—Å–∫ kernel –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
launch_panorama_kernel(..., cuda_stream);
// CPU —Å—Ä–∞–∑—É –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É!

// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç
cudaStreamSynchronize(cuda_stream);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- CPU –º–æ–∂–µ—Ç –≥–æ—Ç–æ–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä –ø–æ–∫–∞ GPU —Ä–∞–±–æ—Ç–∞–µ—Ç
- Overlap CPU –∏ GPU —Ä–∞–±–æ—Ç—ã
- –õ—É—á—à–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

---

## 7. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### 7.1. Breakdown –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∫–∞–¥—Ä (~20ms total)

```
–û–ø–µ—Ä–∞—Ü–∏—è                    –í—Ä–µ–º—è     %
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CUDA kernel (GPU)          17.5ms   87%  ‚Üê –ì–ª–∞–≤–Ω–æ–µ —É–∑–∫–æ–µ –º–µ—Å—Ç–æ
NvBufSurfTransform (GPU)    1-2ms    8%
CPU overhead                 0.5ms    2%
EGL mapping (cache HIT)     0.01ms   <1%
–ü—Ä–æ—á–µ–µ                      0.5ms    2%
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–ò–¢–û–ì–û                      ~20ms   100%
FPS: ~50 (—Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π)
FPS: ~44 (—Ä–µ–∞–ª—å–Ω—ã–π —Å —É—á—ë—Ç–æ–º overhead)
```

### 7.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

**GPU**:
- –ü–∞–º—è—Ç—å: ~350 MB (LUT 244MB + –±—É—Ñ–µ—Ä—ã 106MB)
- –ó–∞–≥—Ä—É–∑–∫–∞: ~85% (–ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ –∑–∞–Ω—è—Ç CUDA kernel)
- –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏: ~16% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞

**CPU**:
- –ó–∞–≥—Ä—É–∑–∫–∞: ~23% (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è, –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞ GPU)
- –ü–∞–º—è—Ç—å: ~200 MB

---

## 8. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### 8.1. –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**nvstreammux**:
```bash
batch-size=2           # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ! (left + right)
width=3840
height=2160
batched-push-timeout=40000  # 40ms timeout
```

**nvdsstitch**:
```bash
left-source-id=0       # ID –ª–µ–≤–æ–π –∫–∞–º–µ—Ä—ã
right-source-id=1      # ID –ø—Ä–∞–≤–æ–π –∫–∞–º–µ—Ä—ã
gpu-id=0
use-egl=true           # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Jetson!
```

### 8.2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è

**–ß—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å**:
```
1. FPS - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ ~44-48
2. Latency - –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å ~17-20ms
3. EGL cache hit rate - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >95%
4. CUDA errors - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
5. NULL pointer errors - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
```

**–ü—Ä–∏–∑–Ω–∞–∫–∏ –ø—Ä–æ–±–ª–µ–º**:
- FPS –ø–∞–¥–∞–µ—Ç –Ω–∏–∂–µ 40 ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É GPU
- Latency —Ä–∞—Å—Ç—ë—Ç ‚Üí –≤–æ–∑–º–æ–∂–Ω–æ throttling
- Cache hit rate <90% ‚Üí —É–≤–µ–ª–∏—á–∏—Ç—å CACHE_MAX_SIZE
- CUDA errors ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å LUT —Ñ–∞–π–ª—ã

---

## 9. Troubleshooting

**–ü—Ä–æ–±–ª–µ–º–∞**: "Failed to map EGL"
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `use-egl=true` –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ aarch64

**–ü—Ä–æ–±–ª–µ–º–∞**: "Incomplete batch"
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ nvstreammux –∏–º–µ–µ—Ç `batch-size=2`

**–ü—Ä–æ–±–ª–µ–º–∞**: "CUDA kernel failed: invalid argument"
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å LUT —Ñ–∞–π–ª—ã, —Ä–∞–∑–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ—á–Ω–æ 42597376 bytes

**–ü—Ä–æ–±–ª–µ–º–∞**: FPS –Ω–µ—Å—Ç–∞–±–∏–ª–µ–Ω
**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É (`tegrastats`), –≤–æ–∑–º–æ–∂–µ–Ω throttling

---

**–î–∞—Ç–∞**: 2025-10-17
**–í–µ—Ä—Å–∏—è –ø–ª–∞–≥–∏–Ω–∞**: 1.0 (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
**–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: NVIDIA Jetson Orin Nano 16GB
**CUDA**: 12.6
**DeepStream**: 7.1
