# Makefile –¥–ª—è GStreamer nvdsstitch plugin

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
CXX = g++
NVCC = /usr/local/cuda-12.6/bin/nvcc

# –ë–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
CXXFLAGS = -fPIC -Wall -Wextra -O3 -std=c++14
NVCCFLAGS = -m64 -Xcompiler -fPIC -Xcompiler -fvisibility=hidden
NVCCFLAGS += -gencode arch=compute_87,code=sm_87
NVCCFLAGS += -O3 -use_fast_math --expt-relaxed-constexpr

# –ü—É—Ç–∏ –∫ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–º —Ñ–∞–π–ª–∞–º
INCLUDES = -I. \
           -Isrc \
           -I/usr/local/cuda-12.6/include \
           -I/opt/nvidia/deepstream/deepstream-7.1/sources/includes

# GStreamer —Ñ–ª–∞–≥–∏
GST_CFLAGS = $(shell pkg-config --cflags gstreamer-1.0 gstreamer-base-1.0 gstreamer-video-1.0)
GST_LIBS = $(shell pkg-config --libs gstreamer-1.0 gstreamer-base-1.0 gstreamer-video-1.0)

# DeepStream –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
DS_LIBS = -L/opt/nvidia/deepstream/deepstream-7.1/lib \
          -lnvdsgst_meta -lnvds_meta -lnvdsgst_helper -lnvbufsurface -lnvbufsurftransform

# CUDA –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
CUDA_LIBS = -L/usr/local/cuda-12.6/lib64 -lcudart -lcuda

# –¶–µ–ª–µ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
TARGET = libnvdsstitch.so

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
CPP_SOURCES = src/gstnvdsstitch.cpp \
              src/gstnvdsstitch_allocator.cpp

# CUDA –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã - –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
CUDA_SOURCES = src/cuda_stitch_kernel.cu \

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
CPP_OBJECTS = $(CPP_SOURCES:.cpp=.o)
CUDA_OBJECTS = $(CUDA_SOURCES:.cu=.o)

# –í—Å–µ –æ–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
OBJECTS = $(CPP_OBJECTS) $(CUDA_OBJECTS)

# –¶–≤–µ—Ç–æ–≤—ã–µ –∫–æ–¥—ã –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m # No Color

# –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
all: check-cuda $(TARGET)
	@echo -e "$(GREEN)‚úì Build complete!$(NC)"
	@echo -e "$(BLUE)Plugin location: $(PWD)/$(TARGET)$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ CUDA
check-cuda:
	@echo -e "$(BLUE)Checking CUDA installation...$(NC)"
	@if [ ! -f "$(NVCC)" ]; then \
		echo -e "$(RED)Error: NVCC not found at $(NVCC)$(NC)"; \
		exit 1; \
	fi
	@$(NVCC) --version | head -n 1

# –õ–∏–Ω–∫–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
$(TARGET): $(OBJECTS)
	@echo -e "$(YELLOW)üîó Linking $(TARGET)...$(NC)"
	$(CXX) -shared -o $@ $^ $(GST_LIBS) $(DS_LIBS) $(CUDA_LIBS)
	@echo -e "$(GREEN)‚úì Library created: $@$(NC)"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è C++ —Ñ–∞–π–ª–æ–≤
src/%.o: src/%.cpp
	@echo -e "$(BLUE)üî® Compiling $<...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) $(GST_CFLAGS) -c $< -o $@

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è CUDA —Ñ–∞–π–ª–æ–≤
src/%.o: src/%.cu
	@echo -e "$(YELLOW)üöÄ Compiling CUDA $<...$(NC)"
	$(NVCC) $(NVCCFLAGS) $(INCLUDES) -std=c++14 -c $< -o $@



# –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–û–ì–û texture kernel
src/cuda_stitch_kernel_optimized.o: src/cuda_stitch_kernel_optimized.cu
	@echo -e "$(BLUE)üöÄ Compiling OPTIMIZED TEXTURE kernel...$(NC)"
	$(NVCC) $(NVCCFLAGS) $(INCLUDES) -std=c++14 -c $< -o $@
	@echo -e "$(GREEN)‚úì Optimized texture kernel compiled$(NC)"

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo -e "$(YELLOW)üßπ Cleaning...$(NC)"
	rm -f $(OBJECTS) $(TARGET)
	rm -f src/*.o
	@echo -e "$(GREEN)‚úì Clean complete$(NC)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
install: $(TARGET)
	@echo -e "$(YELLOW)üì¶ Installing plugin...$(NC)"
	@mkdir -p ~/.local/share/gstreamer-1.0/plugins/
	@cp $(TARGET) ~/.local/share/gstreamer-1.0/plugins/
	@echo -e "$(GREEN)‚úì Plugin installed to ~/.local/share/gstreamer-1.0/plugins/$(NC)"
	@echo -e "$(BLUE)Run 'gst-inspect-1.0 nvdsstitch' to verify$(NC)"

# –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞
uninstall:
	@echo -e "$(YELLOW)üóëÔ∏è  Uninstalling plugin...$(NC)"
	@rm -f ~/.local/share/gstreamer-1.0/plugins/$(TARGET)
	@echo -e "$(GREEN)‚úì Plugin uninstalled$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏
check-version: $(TARGET)
	@echo -e "$(BLUE)=== nvdsstitch Version Check ===$(NC)"
	@echo -e "$(YELLOW)Library info:$(NC)"
	@ls -lh $(TARGET)
	@echo -e "\n$(YELLOW)CUDA kernels in library:$(NC)"
	@echo -e "\n$(YELLOW)Available kernels:$(NC)"
	@echo -e "  $(BLUE)‚Ä¢ Texture kernel (standard)$(NC)"
	@echo -e "  $(GREEN)‚Ä¢ Sorted kernel (optimized)$(NC)"

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
test: $(TARGET)
	@echo -e "$(BLUE)üß™ Running test pipeline...$(NC)"
	@echo -e "$(YELLOW)Watch for kernel selection messages...$(NC)"
	GST_DEBUG=nvdsstitch:5 gst-launch-1.0 \
		videotestsrc pattern=ball num-buffers=100 ! \
		video/x-raw,width=3840,height=2160,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! mux.sink_0 \
		videotestsrc pattern=snow num-buffers=100 ! \
		video/x-raw,width=3840,height=2160,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! mux.sink_1 \
		nvstreammux name=mux batch-size=2 width=3840 height=2160 ! \
		nvdsstitch ! fakesink 2>&1 | grep -E "(SORTED|TEXTURE|Sequential|kernel)"

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
profile: $(TARGET)
	@echo -e "$(BLUE)üìä Profiling with Nsight Systems...$(NC)"
	nsys profile --stats=true --output=stitch_profile \
		gst-launch-1.0 \
		videotestsrc num-buffers=300 ! \
		video/x-raw,width=3840,height=2160,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! mux.sink_0 \
		videotestsrc num-buffers=300 ! \
		video/x-raw,width=3840,height=2160,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! mux.sink_1 \
		nvstreammux name=mux batch-size=2 width=3840 height=2160 ! \
		nvdsstitch ! fakesink
	@echo -e "$(GREEN)‚úì Profile saved to stitch_profile.nsys-rep$(NC)"

# –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

# –ü–æ–º–æ—â—å
help:
	@echo -e "$(BLUE)nvdsstitch Makefile$(NC)"
	@echo -e "$(YELLOW)Available targets:$(NC)"
	@echo -e "  $(GREEN)make$(NC)              - Build the plugin"
	@echo -e "  $(GREEN)make clean$(NC)        - Clean build files"
	@echo -e "  $(GREEN)make install$(NC)      - Install plugin to user directory"
	@echo -e "  $(GREEN)make uninstall$(NC)    - Remove installed plugin"
	@echo -e "  $(GREEN)make check-version$(NC)- Check which kernels are included"
	@echo -e "  $(GREEN)make test$(NC)         - Run test pipeline"
	@echo -e "  $(GREEN)make profile$(NC)      - Profile with Nsight Systems"
	@echo -e "  $(GREEN)make benchmark$(NC)    - Compare kernel performance"
	@echo -e "  $(GREEN)make help$(NC)         - Show this help"

.PHONY: all clean install uninstall check-cuda check-version test profile benchmark help

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(CPP_OBJECTS): src/gstnvdsstitch.h src/nvdsstitch_config.h src/cuda_stitch_kernel.h
src/cuda_stitch_kernel.o: src/cuda_stitch_kernel.h src/nvdsstitch_config.h