# Makefile –¥–ª—è GStreamer nvtilebatcher plugin —Å CUDA —è–¥—Ä–æ–º –∏ Allocator
# –ü–ª–∞–≥–∏–Ω –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è –ø–∞–Ω–æ—Ä–∞–º–Ω–æ–≥–æ –≤–∏–¥–µ–æ –Ω–∞ —Ç–∞–π–ª—ã

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
CXX = g++
NVCC = /usr/local/cuda-12.6/bin/nvcc

# –ë–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
CXXFLAGS = -fPIC -D__aarch64__ -Wall -Wextra -O3 -std=c++14 -DPACKAGE=\"nvtilebatcher\"
NVCCFLAGS = -m64 -Xcompiler -fPIC -Xcompiler -fvisibility=hidden
NVCCFLAGS += -gencode arch=compute_87,code=sm_87
NVCCFLAGS += -O3 -use_fast_math --expt-relaxed-constexpr

# –ü—É—Ç–∏ –∫ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–º —Ñ–∞–π–ª–∞–º
INCLUDES = -I. \
           -I/usr/local/cuda-12.6/include \
           -I/opt/nvidia/deepstream/deepstream-7.1/sources/includes \
           -I/opt/nvidia/deepstream/deepstream-7.1/sources/gst-plugins/gst-nvmsgconv \
           -I/opt/nvidia/deepstream/deepstream-7.1/sources/gst-plugins/gst-nvmsgbroker

# GStreamer —Ñ–ª–∞–≥–∏
GST_CFLAGS = $(shell pkg-config --cflags gstreamer-1.0 gstreamer-base-1.0 gstreamer-video-1.0)
GST_LIBS = $(shell pkg-config --libs gstreamer-1.0 gstreamer-base-1.0 gstreamer-video-1.0)

# DeepStream –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
DS_LIBS = -L/opt/nvidia/deepstream/deepstream-7.1/lib \
          -lnvdsgst_meta -lnvds_meta -lnvdsgst_helper \
          -lnvbufsurface -lnvbufsurftransform \
          -lnvds_batch_jpegenc

# CUDA –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
CUDA_LIBS = -L/usr/local/cuda-12.6/lib64 -lcudart -lcuda

# –¶–µ–ª–µ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
TARGET = libnvtilebatcher.so

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
CPP_SOURCES = gstnvtilebatcher.cpp gstnvtilebatcher_allocator.cpp
CUDA_SOURCES = cuda_tile_extractor.cu

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
CPP_OBJECTS = $(CPP_SOURCES:.cpp=.o)
CUDA_OBJECTS = $(CUDA_SOURCES:.cu=.o)

# –í—Å–µ –æ–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
OBJECTS = $(CPP_OBJECTS) $(CUDA_OBJECTS)

# –¶–≤–µ—Ç–æ–≤—ã–µ –∫–æ–¥—ã –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
CYAN = \033[0;36m
MAGENTA = \033[0;35m
NC = \033[0m # No Color

# –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
all: check-deps $(TARGET)
	@echo -e "$(GREEN)‚úì Build complete!$(NC)"
	@echo -e "$(BLUE)Plugin location: $(PWD)/$(TARGET)$(NC)"
	@echo -e "$(CYAN)Components built:$(NC)"
	@echo -e "  - Main plugin (gstnvtilebatcher.o)"
	@echo -e "  - Custom allocator (gstnvtilebatcher_allocator.o)"
	@echo -e "  - CUDA kernel (cuda_tile_extractor.o)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check-deps:
	@echo -e "$(BLUE)Checking dependencies...$(NC)"
	@if [ ! -f "$(NVCC)" ]; then \
		echo -e "$(RED)Error: NVCC not found at $(NVCC)$(NC)"; \
		exit 1; \
	fi
	@if [ ! -d "/opt/nvidia/deepstream/deepstream-7.1" ]; then \
		echo -e "$(RED)Error: DeepStream SDK not found$(NC)"; \
		exit 1; \
	fi
	@echo -e "$(GREEN)‚úì All dependencies found$(NC)"

# –õ–∏–Ω–∫–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
$(TARGET): $(OBJECTS)
	@echo -e "$(YELLOW)üîó Linking $(TARGET) with CUDA support and custom allocator...$(NC)"
	$(CXX) -shared -o $@ $^ $(GST_LIBS) $(DS_LIBS) $(CUDA_LIBS)
	@echo -e "$(GREEN)‚úì Library created: $@$(NC)"
	@echo -e "$(CYAN)  Size: $$(du -h $@ | cut -f1)$(NC)"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è C++ —Ñ–∞–π–ª–æ–≤
%.o: %.cpp
	@echo -e "$(BLUE)üî® Compiling $<...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) $(GST_CFLAGS) -c $< -o $@

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è CUDA —Ñ–∞–π–ª–æ–≤
%.o: %.cu
	@echo -e "$(MAGENTA)üöÄ Compiling CUDA kernel $<...$(NC)"
	$(NVCC) $(NVCCFLAGS) $(INCLUDES) -c $< -o $@

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo -e "$(YELLOW)üßπ Cleaning...$(NC)"
	rm -f $(OBJECTS) $(TARGET)
	rm -f *.o
	@echo -e "$(GREEN)‚úì Clean complete$(NC)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
install: $(TARGET)
	@echo -e "$(YELLOW)üì¶ Installing plugin...$(NC)"
	@mkdir -p ~/.local/share/gstreamer-1.0/plugins/
	@cp $(TARGET) ~/.local/share/gstreamer-1.0/plugins/
	@echo -e "$(GREEN)‚úì Plugin installed to ~/.local/share/gstreamer-1.0/plugins/$(NC)"
	@echo -e "$(CYAN)‚úì Components integrated:$(NC)"
	@echo -e "  - CUDA kernel for tile extraction"
	@echo -e "  - Custom allocator for memory management"
	@echo -e "$(BLUE)Run 'gst-inspect-1.0 nvtilebatcher' to verify$(NC)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (—Ç—Ä–µ–±—É–µ—Ç sudo)
install-system: $(TARGET)
	@echo -e "$(YELLOW)üì¶ Installing plugin system-wide...$(NC)"
	@if [ -w "/usr/lib/aarch64-linux-gnu/gstreamer-1.0/" ]; then \
		cp $(TARGET) /usr/lib/aarch64-linux-gnu/gstreamer-1.0/; \
		echo -e "$(GREEN)‚úì Plugin installed to system directory$(NC)"; \
	else \
		echo -e "$(RED)Error: Need sudo permissions. Run: sudo make install-system$(NC)"; \
		exit 1; \
	fi

# –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞
uninstall:
	@echo -e "$(YELLOW)üóëÔ∏è  Uninstalling plugin...$(NC)"
	@rm -f ~/.local/share/gstreamer-1.0/plugins/$(TARGET)
	@echo -e "$(GREEN)‚úì Plugin uninstalled$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞–≥–∏–Ω–∞
check: $(TARGET) install
	@echo -e "$(BLUE)=== nvtilebatcher Plugin Check ===$(NC)"
	@echo -e "$(YELLOW)Plugin info:$(NC)"
	@gst-inspect-1.0 nvtilebatcher || echo -e "$(RED)Plugin not found in GStreamer registry$(NC)"

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Å —Ç–µ—Å—Ç–æ–≤—ã–º –≤–∏–¥–µ–æ
test-simple: $(TARGET) install
	@echo -e "$(MAGENTA)üöÄ Testing with test video...$(NC)"
	GST_DEBUG=nvtilebatcher:4 gst-launch-1.0 -v \
		videotestsrc num-buffers=30 pattern=ball ! \
		video/x-raw,width=6528,height=1632,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! \
		nvtilebatcher gpu-id=0 silent=false ! \
		fakesink sync=false
	@echo -e "$(GREEN)‚úì Simple test complete$(NC)"

# –¢–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
test-image: $(TARGET) install
	@echo -e "$(BLUE)üß™ Testing with panoramic image...$(NC)"
	@if [ ! -f "panorama.jpg" ]; then \
		echo -e "$(RED)Error: panorama.jpg not found$(NC)"; \
		echo -e "$(YELLOW)Please provide a 6528x1632 panorama image$(NC)"; \
		exit 1; \
	fi
	gst-launch-1.0 -v \
		filesrc location=panorama.jpg ! \
		jpegdec ! \
		videoconvert ! \
		video/x-raw,format=RGBA,width=6528,height=1632 ! \
		nvvideoconvert ! \
		'video/x-raw(memory:NVMM),format=RGBA' ! \
		nvtilebatcher gpu-id=0 ! \
		fakesink
	@echo -e "$(GREEN)‚úì Image test complete$(NC)"

# –¢–µ—Å—Ç —Å Python
test-python: $(TARGET) install
	@echo -e "$(BLUE)üêç Running Python test script...$(NC)"
	@if [ -f "test_tilebatcher.py" ]; then \
		python3 test_tilebatcher.py; \
	else \
		echo -e "$(RED)Error: test_tilebatcher.py not found$(NC)"; \
		exit 1; \
	fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ —Å valgrind
test-memcheck: $(TARGET) install
	@echo -e "$(YELLOW)üîç Checking for memory leaks...$(NC)"
	valgrind --leak-check=full --show-leak-kinds=all \
		gst-launch-1.0 \
		videotestsrc num-buffers=10 ! \
		video/x-raw,width=6528,height=1632,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! \
		nvtilebatcher ! \
		fakesink
	@echo -e "$(GREEN)‚úì Memory check complete$(NC)"

# –ë–µ–Ω—á–º–∞—Ä–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
benchmark: $(TARGET) install
	@echo -e "$(MAGENTA)üìä Benchmarking performance (300 frames)...$(NC)"
	@echo -e "$(CYAN)Processing 300 frames at 30fps...$(NC)"
	@time GST_DEBUG=nvtilebatcher:2 gst-launch-1.0 \
		videotestsrc num-buffers=300 ! \
		video/x-raw,width=6528,height=1632,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! \
		nvtilebatcher silent=false ! \
		fakesink sync=false
	@echo -e "$(GREEN)‚úì Benchmark complete$(NC)"

# –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å nvprof
profile: $(TARGET) install
	@echo -e "$(BLUE)üìä Profiling CUDA kernels...$(NC)"
	@which nvprof >/dev/null 2>&1 || (echo -e "$(RED)nvprof not found. Try nsys instead$(NC)" && exit 1)
	nvprof --print-gpu-summary \
		gst-launch-1.0 \
		videotestsrc num-buffers=30 ! \
		video/x-raw,width=6528,height=1632,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! \
		nvtilebatcher ! \
		fakesink sync=false
	@echo -e "$(GREEN)‚úì Profiling complete$(NC)"

# –û—Ç–ª–∞–¥–∫–∞ —Å gdb
debug: $(TARGET) install
	@echo -e "$(YELLOW)üîç Starting debugger...$(NC)"
	GST_DEBUG=nvtilebatcher:5 gdb --args gst-launch-1.0 \
		videotestsrc num-buffers=1 ! \
		video/x-raw,width=6528,height=1632,framerate=30/1 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! \
		nvtilebatcher ! \
		fakesink

# –ü–æ–º–æ—â—å
help:
	@echo -e "$(BLUE)nvtilebatcher Makefile with Custom Allocator$(NC)"
	@echo -e "$(YELLOW)Build targets:$(NC)"
	@echo -e "  $(GREEN)make$(NC)              - Build plugin with allocator"
	@echo -e "  $(GREEN)make clean$(NC)        - Clean all build files"
	@echo -e "  $(GREEN)make install$(NC)      - Install to user directory"
	@echo -e "  $(GREEN)make uninstall$(NC)    - Remove installed plugin"
	@echo -e ""
	@echo -e "$(YELLOW)Testing targets:$(NC)"
	@echo -e "  $(GREEN)make test-simple$(NC)  - Test with test video"
	@echo -e "  $(GREEN)make test-image$(NC)   - Test with panorama.jpg"
	@echo -e "  $(GREEN)make test-python$(NC)  - Run Python test script"
	@echo -e "  $(GREEN)make test-memcheck$(NC) - Check for memory leaks"
	@echo -e "  $(GREEN)make benchmark$(NC)    - Benchmark performance"
	@echo -e "  $(GREEN)make profile$(NC)      - Profile CUDA kernels"
	@echo -e "  $(GREEN)make debug$(NC)        - Debug with gdb"
	@echo -e ""
	@echo -e "$(YELLOW)Other:$(NC)"
	@echo -e "  $(GREEN)make check$(NC)        - Verify plugin installation"
	@echo -e "  $(GREEN)make help$(NC)         - Show this help"

.PHONY: all clean install install-system uninstall check test-simple test-image test-python test-memcheck benchmark profile debug help check-deps

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
gstnvtilebatcher.o: gstnvtilebatcher.h gstnvtilebatcher_allocator.h
gstnvtilebatcher_allocator.o: gstnvtilebatcher_allocator.h
cuda_tile_extractor.o: cuda_tile_extractor.cu