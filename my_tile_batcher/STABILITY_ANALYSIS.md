# –ê–Ω–∞–ª–∏–∑ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –ø–ª–∞–≥–∏–Ω–∞ nvtilebatcher

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 18 –æ–∫—Ç—è–±—Ä—è 2025
**–ü–ª–∞–≥–∏–Ω:** nvtilebatcher (GStreamer)
**–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:** Jetson Orin (DeepStream 7.1)
**–í–µ—Ä—Å–∏—è:** 1.0

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ](#–∫—Ä–∞—Ç–∫–æ–µ-—Ä–µ–∑—é–º–µ)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞–≥–∏–Ω–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–ø–ª–∞–≥–∏–Ω–∞)
3. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 1)](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã-priority-1)
4. [–í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 2)](#–≤–∞–∂–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-priority-2)
5. [–°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 3)](#—Å—Ä–µ–¥–Ω–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã-priority-3)
6. [–ù–∏–∑–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 4)](#–Ω–∏–∑–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã-priority-4)
7. [–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞](#–∏—Ç–æ–≥–æ–≤–∞—è-–æ—Ü–µ–Ω–∫–∞)

---

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏: **6/10** ‚ö†Ô∏è

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|-----------|------------|-------------|
| üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ | 3 | –í—ã—Å–æ–∫–∞—è |
| üü† –í–∞–∂–Ω—ã–µ | 4 | –°—Ä–µ–¥–Ω—è—è |
| üü° –°—Ä–µ–¥–Ω–∏–µ | 3 | –ù–∏–∑–∫–∞—è |
| üü¢ –ù–∏–∑–∫–∏–µ | 2 | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è |

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã:

‚úÖ **–ß—Ç–æ —Ö–æ—Ä–æ—à–æ:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ EGL –∫–µ—à–∞ –¥–ª—è –≤—Ö–æ–¥–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ (—Å–Ω–∏–∂–∞–µ—Ç overhead)
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª –≤—ã—Ö–æ–¥–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤ (–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è –ø–∞–º—è—Ç—å)
- CUDA stream –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ë–∞–∑–æ–≤–∞—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (mutex –¥–ª—è EGL –∫–µ—à–∞)

‚ùå **–ß—Ç–æ –ø–ª–æ—Ö–æ:**
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–æ–∫ CUDA –æ—à–∏–±–æ–∫ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ race conditions –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å output_pool_fixed
- –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ –≤—Ö–æ–¥–Ω—ã—Ö –±—É—Ñ–µ—Ä–æ–≤
- –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- DEBUG –ª–æ–≥–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç GST_ERROR –≤–º–µ—Å—Ç–æ GST_DEBUG

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–ª–∞–≥–∏–Ω–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

```
nvtilebatcher (GstBaseTransform)
‚îú‚îÄ‚îÄ Input: Panorama (6528√ó1632 RGBA, NVMM)
‚îú‚îÄ‚îÄ Output: Batch of 6 tiles (6√ó1024√ó1024 RGBA, NVMM)
‚îú‚îÄ‚îÄ EGL Cache (g_hash_table) - –∫–µ—à –≤—Ö–æ–¥–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
‚îú‚îÄ‚îÄ Fixed Output Pool (4 –±—É—Ñ–µ—Ä–∞) - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª
‚îú‚îÄ‚îÄ CUDA Stream - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
‚îî‚îÄ‚îÄ Metadata Processing - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ NvDsBatchMeta
```

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏:

```
1. submit_input_buffer()
   ‚Üì
2. –ü–æ–ª—É—á–∏—Ç—å –≤—Ö–æ–¥–Ω–æ–π –±—É—Ñ–µ—Ä (–ø–∞–Ω–æ—Ä–∞–º–∞)
   ‚Üì
3. –ú–∞–ø–ø–∏–Ω–≥ EGL ‚Üí CUDA (—á–µ—Ä–µ–∑ –∫–µ—à)
   ‚Üì
4. –ü–æ–ª—É—á–∏—Ç—å –≤—ã—Ö–æ–¥–Ω–æ–π –±—É—Ñ–µ—Ä –∏–∑ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—É–ª–∞
   ‚Üì
5. cuda_extract_tiles() - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–∞–π–ª–æ–≤
   ‚Üì
6. cudaEventSynchronize() - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
   ‚Üì
7. process_and_update_metadata() - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
   ‚Üì
8. gst_pad_push() - –æ—Ç–ø—Ä–∞–≤–∫–∞ downstream
```

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 1)

### ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ #1: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ cudaEventSynchronize**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:561-564`

**–ö–æ–¥:**
```cpp
// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è CUDA
if (batcher->frame_complete_event) {
    cudaEventRecord(batcher->frame_complete_event, batcher->cuda_stream);
    cudaEventSynchronize(batcher->frame_complete_event);  // ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—à–∏–±–∫–∏!
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `cudaEventSynchronize()` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É, –µ—Å–ª–∏ GPU kernel —É–ø–∞–ª –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
- –ë–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞–≥–∏–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- Downstream –ø–ª–∞–≥–∏–Ω—ã –ø–æ–ª—É—á–∞—Ç –º—É—Å–æ—Ä –≤–º–µ—Å—Ç–æ —Ç–∞–π–ª–æ–≤

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Segmentation fault –≤ nvinfer
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–µ—Ç–µ–∫—Ü–∏–∏
- –ú–æ–ª—á–∞–ª–∏–≤—ã–µ —Å–±–æ–∏ pipeline

**–†–∏—Å–∫:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
cudaError_t cuda_err = cudaEventSynchronize(batcher->frame_complete_event);
if (cuda_err != cudaSuccess) {
    GST_ERROR_OBJECT(batcher, "CUDA event synchronization failed: %s",
                     cudaGetErrorString(cuda_err));
    gst_buffer_unref(output_buf);
    gst_buffer_unref(inbuf);
    return GST_FLOW_ERROR;
}
```

---

### ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ #2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:459-468`

**–ö–æ–¥:**
```cpp
NvBufSurface *input_surface = (NvBufSurface *)in_map.data;

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –ø–∞–º—è—Ç–∏
if (input_surface->memType != NVBUF_MEM_SURFACE_ARRAY) {
    GST_ERROR_OBJECT(batcher, "Input surface is not SURFACE_ARRAY type: %d",
                    input_surface->memType);
    gst_buffer_unmap(inbuf, &in_map);
    gst_buffer_unref(inbuf);
    return GST_FLOW_ERROR;
}
// ‚ùå –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑–º–µ—Ä–æ–≤!
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ `input_surface->surfaceList[0].width` –∏ `height`
- –ï—Å–ª–∏ upstream –æ—Ç–ø—Ä–∞–≤–∏—Ç –±—É—Ñ–µ—Ä –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, CUDA kernel –±—É–¥–µ—Ç —á–∏—Ç–∞—Ç—å out-of-bounds
- –í–æ–∑–º–æ–∂–µ–Ω segfault –∏–ª–∏ memory corruption

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Segmentation fault –≤ CUDA kernel
- Memory corruption (—á—Ç–µ–Ω–∏–µ –∑–∞ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –ø–∞–º—è—Ç–∏)
- –ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

**–†–∏—Å–∫:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –≤—Ö–æ–¥–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞
if (input_surface->surfaceList[0].width != PANORAMA_WIDTH ||
    input_surface->surfaceList[0].height != PANORAMA_HEIGHT) {
    GST_ERROR_OBJECT(batcher,
        "Invalid input buffer size: %dx%d (expected %dx%d)",
        input_surface->surfaceList[0].width,
        input_surface->surfaceList[0].height,
        PANORAMA_WIDTH, PANORAMA_HEIGHT);
    gst_buffer_unmap(inbuf, &in_map);
    gst_buffer_unref(inbuf);
    return GST_FLOW_ERROR;
}
```

---

### ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞ #3: Race condition –≤ output_pool_fixed**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:495-516`

**–ö–æ–¥:**
```cpp
// –ü–æ–ª—É—á–∞–µ–º –≤—ã—Ö–æ–¥–Ω–æ–π –±—É—Ñ–µ—Ä –∏–∑ –ø—É–ª–∞
g_mutex_lock(&batcher->output_pool_fixed.mutex);
gint buf_idx = batcher->output_pool_fixed.current_index;
GstBuffer *pool_buf = batcher->output_pool_fixed.buffers[buf_idx];
NvBufSurface *output_surface = batcher->output_pool_fixed.surfaces[buf_idx];

// ... —Ä–∞–±–æ—Ç–∞ —Å output_surface ...

batcher->output_pool_fixed.current_index = (buf_idx + 1) % FIXED_OUTPUT_POOL_SIZE;
g_mutex_unlock(&batcher->output_pool_fixed.mutex);

// ‚ùå –ü–æ—Å–ª–µ unlock –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —ç—Ç–æ—Ç –∂–µ –±—É—Ñ–µ—Ä!
// –ê –º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ —Å—Ç—Ä–æ–∫–∏ 585...
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Mutex —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ –±—É—Ñ–µ—Ä
- –ù–æ —Å–∞–º –±—É—Ñ–µ—Ä –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–æ –∫–æ–Ω—Ü–∞ —Ñ—É–Ω–∫—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 519-574)
- –ï—Å–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –≤—ã–∑–æ–≤–µ—Ç `submit_input_buffer()`, –æ–Ω –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—Ç –∂–µ `buf_idx`
- –î–≤–∞ –ø–æ—Ç–æ–∫–∞ –±—É–¥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∏—Å–∞—Ç—å –≤ –æ–¥–∏–Ω –±—É—Ñ–µ—Ä ‚Üí race condition

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –¢–∞–π–ª—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤ —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è
- –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–µ—Ç–µ–∫—Ü–∏–∏

**–†–∏—Å–∫:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô** (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
// –î–µ—Ä–∂–∏–º mutex –¥–æ –∫–æ–Ω—Ü–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±—É—Ñ–µ—Ä–∞
g_mutex_lock(&batcher->output_pool_fixed.mutex);

gint buf_idx = batcher->output_pool_fixed.current_index;
// ... –≤—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ...
batcher->output_pool_fixed.current_index = (buf_idx + 1) % FIXED_OUTPUT_POOL_SIZE;

g_mutex_unlock(&batcher->output_pool_fixed.mutex);  // –¢–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ü–µ!
```

**–ò–õ–ò** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å reference counting –¥–ª—è –±—É—Ñ–µ—Ä–æ–≤.

---

## –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 2)

### ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ #4: –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:369-414`

**–ö–æ–¥:**
```cpp
for (int i = 0; i < TILES_PER_BATCH; i++) {
    NvDsFrameMeta *frame_meta = NULL;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ DeepStream –µ—Å–ª–∏ –ø—É–ª –µ—Å—Ç—å
    if (batch_meta->frame_meta_pool) {
        frame_meta = nvds_acquire_frame_meta_from_pool(batch_meta);
    }

    if (!frame_meta) {
        frame_meta = (NvDsFrameMeta *)g_malloc0(sizeof(NvDsFrameMeta));
        frame_meta->base_meta.meta_type = (NvDsMetaType)NVDS_FRAME_META;
    }

    // ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ frame_meta ...

    // –î–æ–±–∞–≤–ª—è–µ–º user_meta
    NvDsUserMeta *user_meta = nvds_acquire_user_meta_from_pool(batch_meta);

    if (user_meta) {  // ‚ùå –ê –µ—Å–ª–∏ user_meta == NULL?
        TileRegionInfo *tile_info = g_new0(TileRegionInfo, 1);
        // ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ tile_info ...
        nvds_add_user_meta_to_frame(frame_meta, user_meta);
    }
    // ‚ùå –ï—Å–ª–∏ user_meta == NULL, tile_info –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ

    batch_meta->frame_meta_list = g_list_append(batch_meta->frame_meta_list, frame_meta);
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ `nvds_acquire_frame_meta_from_pool()` –≤–µ—Ä–Ω—ë—Ç NULL, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `g_malloc0()`
- –≠—Ç–∞ –ø–∞–º—è—Ç—å –Ω–µ –±—É–¥–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞ DeepStream –ø—É–ª–æ–º (–æ–Ω –ø—Ä–æ –Ω–µ—ë –Ω–µ –∑–Ω–∞–µ—Ç)
- –ü—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ batch_meta –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ —É—Ç–µ—á–∫–∞

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Memory leak (–Ω–µ–±–æ–ª—å—à–æ–π, –Ω–æ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π)
- –ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã –≤–æ–∑–º–æ–∂–Ω–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

**–†–∏—Å–∫:** üü† **–í–ê–ñ–ù–´–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
NvDsFrameMeta *frame_meta = nvds_acquire_frame_meta_from_pool(batch_meta);

if (!frame_meta) {
    GST_WARNING_OBJECT(batcher,
        "Failed to acquire frame_meta from pool for tile %d", i);
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —Ç–∞–π–ª –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
    continue;
}
```

---

### ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ #5: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ g_hash_table_insert**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:115-128`

**–ö–æ–¥:**
```cpp
g_mutex_lock(&batcher->egl_cache_mutex);

if (!cache_entry) {
    cache_entry = g_new0(EGLResourceCacheEntry, 1);
    g_hash_table_insert(batcher->egl_cache, egl_image, cache_entry);  // ‚ùå –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
}

cache_entry->egl_image = egl_image;
// ...

g_mutex_unlock(&batcher->egl_cache_mutex);
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `g_hash_table_insert()` –º–æ–∂–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å (–µ—Å–ª–∏ key —É–∂–µ –µ—Å—Ç—å)
- –°—Ç–∞—Ä–∞—è –∑–∞–ø–∏—Å—å –±—É–¥–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞ —á–µ—Ä–µ–∑ `egl_cache_entry_free()`
- –ù–æ –º—ã —É–∂–µ —Ä–∞–∑—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏ CUDA —Ä–µ—Å—É—Ä—Å –≤ —Å—Ç—Ä–æ–∫–µ 110
- –í–æ–∑–º–æ–∂–Ω–∞ double-free –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Double-free –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö
- Corrupted memory
- Segfault

**–†–∏—Å–∫:** üü† **–í–ê–ñ–ù–´–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
if (!cache_entry) {
    cache_entry = g_new0(EGLResourceCacheEntry, 1);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª—é—á–∞ –µ—â—ë –Ω–µ—Ç
    if (g_hash_table_contains(batcher->egl_cache, egl_image)) {
        GST_WARNING_OBJECT(batcher,
            "EGL image %p already in cache, replacing", egl_image);
    }

    g_hash_table_insert(batcher->egl_cache, egl_image, cache_entry);
}
```

---

### ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ #6: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ NvBufSurfaceMapEglImage**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:472-479`

**–ö–æ–¥:**
```cpp
void* src_ptr = NULL;
if (!input_surface->surfaceList[0].mappedAddr.eglImage) {
    if (NvBufSurfaceMapEglImage(input_surface, 0) != 0) {
        GST_ERROR_OBJECT(batcher, "Failed to map EGL image for input");
        gst_buffer_unmap(inbuf, &in_map);
        gst_buffer_unref(inbuf);
        return GST_FLOW_ERROR;
    }
    // ‚ùå –ê –µ—Å–ª–∏ –º–∞–ø–ø–∏–Ω–≥ –ø—Ä–æ—à—ë–ª, –Ω–æ eglImage –≤—Å—ë —Ä–∞–≤–Ω–æ NULL?
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ return code –æ—Ç `NvBufSurfaceMapEglImage()`
- –ù–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ `eglImage` –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –º–∞–ø–ø–∏–Ω–≥–∞
- –í–æ–∑–º–æ–∂–Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—è, –∫–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ 0, –Ω–æ `eglImage` –æ—Å—Ç–∞–ª—Å—è NULL

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- NULL pointer dereference –≤ —Å—Ç—Ä–æ–∫–µ 484
- Segmentation fault

**–†–∏—Å–∫:** üü† **–í–ê–ñ–ù–´–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
if (NvBufSurfaceMapEglImage(input_surface, 0) != 0) {
    GST_ERROR_OBJECT(batcher, "Failed to map EGL image for input");
    gst_buffer_unmap(inbuf, &in_map);
    gst_buffer_unref(inbuf);
    return GST_FLOW_ERROR;
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–∞–ø–ø–∏–Ω–≥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∏–∑–æ—à—ë–ª
if (!input_surface->surfaceList[0].mappedAddr.eglImage) {
    GST_ERROR_OBJECT(batcher, "EGL image is NULL after mapping");
    gst_buffer_unmap(inbuf, &in_map);
    gst_buffer_unref(inbuf);
    return GST_FLOW_ERROR;
}
```

---

### ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ #7: –ù–µ–æ—á–µ–≤–∏–¥–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ tile_region_info_free**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.h:77-82`

**–ö–æ–¥:**
```cpp
static void tile_region_info_free(gpointer data, gpointer user_data)
{
    (void)user_data;
    // –ù–ï –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º data –∑–¥–µ—Å—å - DeepStream —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º
    // g_free(data); // –£–ë–†–ê–¢–¨ –≠–¢–£ –°–¢–†–û–ö–£!
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§—É–Ω–∫—Ü–∏—è —Å –∏–º–µ–Ω–µ–º `*_free()` –ù–ï –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø–∞–º—è—Ç—å - —ç—Ç–æ –∫–æ–Ω—Ç—Ä–∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ
- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ "DeepStream —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º", –Ω–æ —ç—Ç–æ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
- –ï—Å–ª–∏ DeepStream –ù–ï –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç, –±—É–¥–µ—Ç —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏
- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, –∫—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Memory leak (–µ—Å–ª–∏ DeepStream –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç)
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–†–∏—Å–∫:** üü† **–í–ê–ñ–ù–´–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
static void tile_region_info_free(gpointer data, gpointer user_data)
{
    (void)user_data;

    if (data) {
        g_free(data);
    }
}
```

**–ò–õ–ò** –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ `tile_region_info_release()` —Å –ø—É—Å—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π.

---

## –°—Ä–µ–¥–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 3)

### ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ #8: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GST_ERROR –¥–ª—è debug –ª–æ–≥–æ–≤**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Å—Ç –≤ `gstnvtilebatcher.cpp`

**–ü—Ä–∏–º–µ—Ä—ã:**
```cpp
GST_ERROR_OBJECT(batcher, "BEFORE: output_surface->numFilled = %d", ...);  // –°—Ç—Ä–æ–∫–∞ 500
GST_ERROR_OBJECT(batcher, "BEFORE: output_surface->batchSize = %d", ...);  // –°—Ç—Ä–æ–∫–∞ 501
GST_ERROR_OBJECT(batcher, "BEFORE: cuda_extract_tiles = %d", ...);         // –°—Ç—Ä–æ–∫–∞ 540-541
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `GST_ERROR` —Å–æ–∑–¥–∞—ë—Ç –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ, —á—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
- –≠—Ç–æ debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å `GST_DEBUG` –∏–ª–∏ `GST_LOG`
- –ó–∞—Å–æ—Ä—è–µ—Ç –ª–æ–≥–∏, —É—Å–ª–æ–∂–Ω—è–µ—Ç –ø–æ–∏—Å–∫ —Ä–µ–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –¢—Ä—É–¥–Ω–æ –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –æ—Ç debug —Å–æ–æ–±—â–µ–Ω–∏–π
- –õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

**–†–∏—Å–∫:** üü° **–°–†–ï–î–ù–ò–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
GST_DEBUG_OBJECT(batcher, "Before extraction: numFilled=%d, batchSize=%d",
                 output_surface->numFilled, output_surface->batchSize);
```

---

### ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ #9: Hardcoded –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤–º–µ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–æ–∫**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:505-506, 179, 366`

**–ö–æ–¥:**
```cpp
output_surface->batchSize = 6;    // ‚ùå Hardcoded
output_surface->numFilled = 6;    // ‚ùå Hardcoded

batch_meta->num_frames_in_batch = 6;  // ‚ùå Hardcoded
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —á–∏—Å–µ–ª `6` –≤–º–µ—Å—Ç–æ `TILES_PER_BATCH`
- –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å `TILES_PER_BATCH`, —ç—Ç–∏ –º–µ—Å—Ç–∞ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤—Ä—É—á–Ω—É—é
- –†–∏—Å–∫ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –¢—Ä—É–¥–Ω–æ—Å—Ç–∏ –ø—Ä–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–∞–≥–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

**–†–∏—Å–∫:** üü° **–°–†–ï–î–ù–ò–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
output_surface->batchSize = TILES_PER_BATCH;
output_surface->numFilled = TILES_PER_BATCH;
batch_meta->num_frames_in_batch = TILES_PER_BATCH;
```

---

### ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ #10: –ù–µ—Ç timeout –¥–ª—è cudaEventSynchronize**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:563`

**–ö–æ–¥:**
```cpp
cudaEventSynchronize(batcher->frame_complete_event);  // ‚ùå –ú–æ–∂–µ—Ç –≤–∏—Å–µ—Ç—å –≤–µ—á–Ω–æ
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ GPU kernel –∑–∞–≤–∏—Å–Ω–µ—Ç, `cudaEventSynchronize()` –±—É–¥–µ—Ç –∂–¥–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
- Pipeline –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ó–∞–≤–∏—Å–∞–Ω–∏–µ –≤—Å–µ–≥–æ pipeline
- –ù–µ–æ–±—Ö–æ–¥–∏–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–†–∏—Å–∫:** üü° **–°–†–ï–î–ù–ò–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
CUDA –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç timeout –¥–ª—è eventSync –Ω–∞–ø—Ä—è–º—É—é, –Ω–æ –º–æ–∂–Ω–æ:
```cpp
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å cudaStreamQuery –≤ —Ü–∏–∫–ª–µ —Å timeout
int timeout_ms = 5000;
int elapsed = 0;
while (elapsed < timeout_ms) {
    cudaError_t status = cudaEventQuery(batcher->frame_complete_event);
    if (status == cudaSuccess) break;
    if (status != cudaErrorNotReady) {
        GST_ERROR_OBJECT(batcher, "CUDA event error: %s",
                         cudaGetErrorString(status));
        return GST_FLOW_ERROR;
    }
    g_usleep(10000);  // 10ms
    elapsed += 10;
}
if (elapsed >= timeout_ms) {
    GST_ERROR_OBJECT(batcher, "CUDA event timeout after %dms", timeout_ms);
    return GST_FLOW_ERROR;
}
```

---

## –ù–∏–∑–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 4)

### üîµ **–ü—Ä–æ–±–ª–µ–º–∞ #11: –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:413`

**–ö–æ–¥:**
```cpp
batch_meta->frame_meta_list = g_list_append(batch_meta->frame_meta_list, frame_meta);
// batch_meta->num_frames_in_batch++;  // ‚ùå –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, –ø–æ—á–µ–º—É —Å—Ç—Ä–æ–∫–∞ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞
- –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –∑–∞–±—ã–ª–∏ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–∏—á–∏–Ω–∞
- –ù–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è, –æ–±—ä—è—Å–Ω—è—é—â–µ–≥–æ –ø—Ä–∏—á–∏–Ω—É

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –ü—É—Ç–∞–Ω–∏—Ü–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –±–∞–≥–æ–≤

**–†–∏—Å–∫:** üü¢ **–ù–ò–ó–ö–ò–ô**

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
–õ–∏–±–æ —É–¥–∞–ª–∏—Ç—å, –ª–∏–±–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
```cpp
// NOTE: num_frames_in_batch —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å—Ç—Ä–æ–∫–µ 366,
// –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç –∑–¥–µ—Å—å –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ —É–¥–≤–æ–µ–Ω–∏—é –∑–Ω–∞—á–µ–Ω–∏—è
```

---

### üîµ **–ü—Ä–æ–±–ª–µ–º–∞ #12: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ NULL –¥–ª—è cuda_stream**

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `gstnvtilebatcher.cpp:548, 561-564`

**–ö–æ–¥:**
```cpp
int result = cuda_extract_tiles(
    src_ptr,
    input_surface->surfaceList[0].width,
    input_surface->surfaceList[0].height,
    input_surface->surfaceList[0].planeParams.pitch[0],
    output_surface->surfaceList[0].planeParams.pitch[0],
    batcher->cuda_stream  // ‚ùå –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ NULL
);

if (batcher->frame_complete_event) {  // ‚úì –ü—Ä–æ–≤–µ—Ä—è–µ–º event
    cudaEventRecord(batcher->frame_complete_event, batcher->cuda_stream);
    cudaEventSynchronize(batcher->frame_complete_event);
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `cuda_stream` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ NULL
- –ï—Å–ª–∏ `gst_nvtilebatcher_start()` –Ω–µ –±—ã–ª –≤—ã–∑–≤–∞–Ω –∏–ª–∏ —É–ø–∞–ª, stream –±—É–¥–µ—Ç NULL
- CUDA API –ø–æ–ª—É—á–∏—Ç NULL stream ‚Üí undefined behavior

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- Segfault –∏–ª–∏ undefined behavior

**–†–∏—Å–∫:** üü¢ **–ù–ò–ó–ö–ò–ô** (–æ–±—ã—á–Ω–æ start() –≤—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```cpp
if (!batcher->cuda_stream) {
    GST_ERROR_OBJECT(batcher, "CUDA stream is NULL");
    return GST_FLOW_ERROR;
}
```

---

## –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞

### –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º:

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –†–∏—Å–∫ | –£—Å–∏–ª–∏—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ |
|---|----------|-----------|------|----------------------|
| 1 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ cudaEventSynchronize | üî¥ P1 | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | 10 –º–∏–Ω |
| 2 | –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞ | üî¥ P1 | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | 10 –º–∏–Ω |
| 3 | Race condition –≤ output_pool_fixed | üî¥ P1 | –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π | 30 –º–∏–Ω |
| 4 | –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö | üü† P2 | –í–∞–∂–Ω—ã–π | 15 –º–∏–Ω |
| 5 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ g_hash_table_insert | üü† P2 | –í–∞–∂–Ω—ã–π | 15 –º–∏–Ω |
| 6 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å–ª–µ NvBufSurfaceMapEglImage | üü† P2 | –í–∞–∂–Ω—ã–π | 10 –º–∏–Ω |
| 7 | –ù–µ–æ—á–µ–≤–∏–¥–Ω–æ–µ tile_region_info_free | üü† P2 | –í–∞–∂–Ω—ã–π | 10 –º–∏–Ω |
| 8 | GST_ERROR –¥–ª—è debug –ª–æ–≥–æ–≤ | üü° P3 | –°—Ä–µ–¥–Ω–∏–π | 15 –º–∏–Ω |
| 9 | Hardcoded –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã | üü° P3 | –°—Ä–µ–¥–Ω–∏–π | 10 –º–∏–Ω |
| 10 | –ù–µ—Ç timeout –¥–ª—è CUDA sync | üü° P3 | –°—Ä–µ–¥–Ω–∏–π | 30 –º–∏–Ω |
| 11 | –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ | üü¢ P4 | –ù–∏–∑–∫–∏–π | 5 –º–∏–Ω |
| 12 | –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ NULL –¥–ª—è cuda_stream | üü¢ P4 | –ù–∏–∑–∫–∏–π | 5 –º–∏–Ω |

**–û–±—â–µ–µ –≤—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** ~2.5 —á–∞—Å–∞

---

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º:

#### üî¥ **–ö—Ä–∏—Ç–∏—á–Ω–æ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):**
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `cudaEventSynchronize` ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #1
2. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ä–∞–∑–º–µ—Ä–æ–≤ –≤—Ö–æ–¥–Ω–æ–≥–æ –±—É—Ñ–µ—Ä–∞ ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #2
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ `output_pool_fixed` ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #3

#### üü† **–í–∞–∂–Ω–æ (–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è):**
4. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —É—Ç–µ—á–∫—É –ø–∞–º—è—Ç–∏ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #4
5. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `g_hash_table_insert` ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #5
6. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ—Å–ª–µ `NvBufSurfaceMapEglImage` ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #6
7. –ò—Å–ø—Ä–∞–≤–∏—Ç—å `tile_region_info_free` ‚Üí –ü—Ä–æ–±–ª–µ–º–∞ #7

#### üü° **–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ:**
8-10. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ–Ω—Å—Ç–∞–Ω—Ç, –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ timeout

#### üü¢ **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:**
11-12. Cleanup –∫–æ–¥–∞, —É–ª—É—á—à–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

---

### –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** | 4/10 | ‚ö†Ô∏è –ú–Ω–æ–≥–æ –Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π |
| **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** | 5/10 | ‚ö†Ô∏è Race condition –≤ –ø—É–ª–µ |
| **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** | 3/10 | ‚ùå –ü–æ—á—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç |
| **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é** | 6/10 | ‚ö†Ô∏è –£—Ç–µ—á–∫–∏ –≤ edge cases |
| **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞** | 7/10 | ‚úÖ –í —Ü–µ–ª–æ–º —Ö–æ—Ä–æ—à–æ |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | 8/10 | ‚úÖ –•–æ—Ä–æ—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è |

---

### –û–±—â–∏–π –≤—ã–≤–æ–¥:

–ü–ª–∞–≥–∏–Ω **nvtilebatcher** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –∏–º–µ–µ—Ç **—Å–µ—Ä—å—ë–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å—é**:

‚úÖ **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CUDA –∏ EGL
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É–ª –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ EGL —Ä–µ—Å—É—Ä—Å–æ–≤

‚ùå **–°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ CUDA
- Race conditions –ø—Ä–∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –£—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏ –≤ edge cases

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (Priority 1) –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤ production. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è –¥–æ **8-9/10**.

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –°–æ–∑–¥–∞—Ç—å `STABILITY_FIXES.md` —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –ø–ª–∞–Ω–æ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.
