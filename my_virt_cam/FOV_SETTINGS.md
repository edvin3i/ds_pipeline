# Финальные настройки FOV

## Текущая конфигурация (оптимизировано)

### Лимиты FOV
- **FOV_MIN**: 40.0°
- **FOV_MAX**: 65.0° ← оптимально для вашей панорамы 5700x1900

### Формула расчёта
```cpp
// 1. Базовый FOV от размера мяча
radius = CLAMP(ball_radius, 5.0, 100.0)
base_fov = 30.0 + (radius - 5.0) × 0.95

// 2. Модификатор зума
zoom_factor = 0.055 / CLAMP(target_ball_size, 0.03, 0.15)

// 3. Итоговый FOV
target_fov = CLAMP(base_fov × zoom_factor, 40.0, 65.0)

// 4. Плавное приближение (каждый кадр)
fov = fov + (target_fov - fov) × smooth_factor  // smooth_factor = 0.15
```

---

## Новый формат вывода

```
⚽ Ball: (1200, 900) | R: 46.0px | FOV: 69.4° (→69.0°) | TS: 0.055 | Up: 142
```

**Расшифровка:**
- `Ball: (1200, 900)` - координаты мяча на панораме
- `R: 46.0px` - радиус мяча
- `FOV: 69.4° (→69.0°)` - **текущий FOV** (плавно движется к **целевому**)
- `TS: 0.055` - target_ball_size
- `Up: 142` - количество обновлений

---

## Понимание разницы между текущим и целевым FOV

### Текущий FOV (69.4°)
- Это реальное значение, которое используется для рендеринга **прямо сейчас**
- Плавно изменяется со скоростью `smooth_factor = 0.15`
- Считывается из плагина через `get_property("fov")`

### Целевой FOV (→69.0°)
- Это значение, к которому стремится камера
- Рассчитывается мгновенно по формуле на основе радиуса и target_ball_size
- Каждый кадр текущий FOV приближается к целевому на 15%

### Почему есть сглаживание?
Без сглаживания камера резко прыгала бы при изменении параметров.
Сглаживание делает движение плавным и приятным для глаз.

**Скорость сглаживания:**
- `smooth_factor = 0.15` означает что за 1 кадр FOV пройдёт 15% пути к цели
- При 30 FPS полная стабилизация занимает ~0.3 секунды
- Можно изменить в `src/nvdsvirtualcam_config.h`: `SMOOTH_FACTOR_DEFAULT`

---

## Быстрая настройка для разных сценариев

### 1. Широкий обзор (65° - максимум)
```bash
# В test_virtual_camera_keyboard.py нажмите:
E E E E E E E E E E E E E E  # Радиус → ~48px
# Результат: FOV → 65° (максимум)
```

### 2. Средний обзор (~55°)
```bash
R  # Сброс (radius=20px, target_ball_size=0.055)
E E E E E E E  # Радиус → ~34px
# Результат: FOV → ~55°
```

### 3. Близкий план (~40° - минимум)
```bash
R  # Сброс
Q Q Q Q Q  # Радиус → 10px
# Результат: FOV → 40° (минимум)
```

### 4. Дополнительный зум через target_ball_size
```bash
# При любом радиусе:
Z Z Z Z  # Уменьшает target_ball_size → увеличивает FOV
X X X X  # Увеличивает target_ball_size → уменьшает FOV
```

---

## Файлы с настройками

### FOV лимиты
**Файл:** `src/nvdsvirtualcam_config.h`
```cpp
constexpr float FOV_MIN = 40.0f;
constexpr float FOV_MAX = 65.0f;  // ← изменить здесь
```

### Формула расчёта
**Файл:** `src/gstnvdsvirtualcam.cpp` (строка ~1264-1273)
```cpp
gfloat radius = CLAMP(vcam->ball_actual_radius, 5.0f, 100.0f);
gfloat base_fov = 30.0f + (radius - 5.0f) * 0.95f;  // ← коэффициент 0.95
gfloat zoom_factor = 0.055f / CLAMP(vcam->target_ball_size, 0.03f, 0.15f);
vcam->target_fov = CLAMP(base_fov * zoom_factor, FOV_MIN, FOV_MAX);
```

### После изменений
```bash
cd src && make
```

---

## Вопросы и ответы

**Q: FOV показывает 69.9° при радиусе 60px, почему не 70.0°?**
A: Из-за сглаживания. Через несколько кадров дойдёт до целевого значения.

**Q: Можно ли отключить сглаживание?**
A: Да, установите `smooth_factor = 1.0` в pipeline или в `nvdsvirtualcam_config.h`

**Q: Почему при радиусе 60px не получается 82°?**
A: Установлен лимит `FOV_MAX = 65.0°`. Измените в конфиге если нужно больше.

**Q: FOV не меняется при нажатии E/Q?**
A: Проверьте что плагин пересобран: `cd src && make`

---

## Рекомендуемые значения для футбола

**Для панорамы 5700x1900:**
- **FOV_MIN**: 40°
- **FOV_MAX**: 65°
- **smooth_factor**: 0.15 (плавное движение)
- **Рабочий диапазон радиуса**: 20-48px
- **Оптимальный FOV для игры**: 50-60°

✅ Текущие настройки оптимальны для вашего кейса!
