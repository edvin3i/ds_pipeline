# Makefile –¥–ª—è GStreamer nvdsvirtualcam plugin - –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
CXX = g++
NVCC = /usr/local/cuda-12.6/bin/nvcc

# –ë–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
CXXFLAGS = -fPIC -Wall -Wextra -O3 -std=c++14
NVCCFLAGS = -m64 -Xcompiler -fPIC -Xcompiler -fvisibility=hidden
NVCCFLAGS += -gencode arch=compute_87,code=sm_87
NVCCFLAGS += -O3 -use_fast_math --expt-relaxed-constexpr
# Register usage validation for occupancy control (CLAUDE.md ¬ß4.5)
NVCCFLAGS += --ptxas-options=-v

# –ü—É—Ç–∏ –∫ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–º —Ñ–∞–π–ª–∞–º
INCLUDES = -I. \
           -I/usr/local/cuda-12.6/include \
           -I/opt/nvidia/deepstream/deepstream-7.1/sources/includes

# GStreamer —Ñ–ª–∞–≥–∏
GST_CFLAGS = $(shell pkg-config --cflags gstreamer-1.0 gstreamer-base-1.0 gstreamer-video-1.0)
GST_LIBS = $(shell pkg-config --libs gstreamer-1.0 gstreamer-base-1.0 gstreamer-video-1.0)

# DeepStream –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
DS_PATH = /opt/nvidia/deepstream/deepstream-7.1
DS_LIBS = -L$(DS_PATH)/lib \
          -lnvdsgst_helper \
          -lnvdsgst_meta \
          -lnvds_meta \
          -lnvbufsurface \
          -lnvbufsurftransform \
          -Wl,-rpath,$(DS_PATH)/lib

# CUDA –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ - –ë–ï–ó cudaEGL –¥–ª—è aarch64!
CUDA_LIBS = -L/usr/local/cuda-12.6/lib64 -lcudart -lcuda

# –î–ª—è Jetson –¥–æ–±–∞–≤–ª—è–µ–º EGL –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
ifeq ($(shell uname -m),aarch64)
    # –ù–∞ Jetson –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π EGL
    CUDA_LIBS += -L/usr/lib/aarch64-linux-gnu -lEGL
endif

# –¶–µ–ª–µ–≤–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
TARGET = libnvdsvirtualcam.so

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã - –≤–∫–ª—é—á–∞–µ–º allocator
CPP_SOURCES = gstnvdsvirtualcam.cpp gstnvdsvirtualcam_allocator.cpp
CUDA_SOURCES = cuda_virtual_cam_kernel.cu

# –û–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã
CPP_OBJECTS = $(CPP_SOURCES:.cpp=.o)
CUDA_OBJECTS = $(CUDA_SOURCES:.cu=.o)
OBJECTS = $(CPP_OBJECTS) $(CUDA_OBJECTS)

# –¶–≤–µ—Ç–æ–≤—ã–µ –∫–æ–¥—ã
RED = \033[0;31m
GREEN = \033[0;32m
YELLOW = \033[1;33m
BLUE = \033[0;34m
NC = \033[0m

# –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
all: check-deps $(TARGET)
	@echo -e "$(GREEN)‚úì Build complete!$(NC)"
	@echo -e "$(BLUE)Plugin location: $(PWD)/$(TARGET)$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check-deps:
	@echo -e "$(BLUE)Checking dependencies...$(NC)"
	@if [ ! -f "gstnvdsvirtualcam_allocator.cpp" ]; then \
		echo -e "$(RED)Error: gstnvdsvirtualcam_allocator.cpp not found!$(NC)"; \
		echo -e "$(YELLOW)Please copy it from DeepStream sources$(NC)"; \
		exit 1; \
	fi
	@if [ ! -f "gstnvdsvirtualcam_allocator.h" ]; then \
		echo -e "$(RED)Error: gstnvdsvirtualcam_allocator.h not found!$(NC)"; \
		echo -e "$(YELLOW)Please copy it from DeepStream sources$(NC)"; \
		exit 1; \
	fi
	@echo -e "$(GREEN)‚úì All required files present$(NC)"

# –õ–∏–Ω–∫–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
$(TARGET): $(OBJECTS)
	@echo -e "$(YELLOW)üîó Linking $(TARGET)...$(NC)"
	@echo -e "$(BLUE)Objects: $(OBJECTS)$(NC)"
	$(CXX) -shared -o $@ $^ $(DS_LIBS) $(CUDA_LIBS) $(GST_LIBS)
	@echo -e "$(GREEN)‚úì Library created$(NC)"
	@echo -e "$(BLUE)Checking library dependencies...$(NC)"
	@ldd $(TARGET) | grep -E "(nvds|cuda)" || true

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è C++ —Ñ–∞–π–ª–æ–≤
%.o: %.cpp
	@echo -e "$(BLUE)üî® Compiling $<...$(NC)"
	$(CXX) $(CXXFLAGS) $(INCLUDES) $(GST_CFLAGS) -c $< -o $@

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è CUDA —Ñ–∞–π–ª–æ–≤ —Å –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ–º warnings
%.o: %.cu
	@echo -e "$(YELLOW)üöÄ Compiling CUDA $<...$(NC)"
	$(NVCC) $(NVCCFLAGS) $(INCLUDES) -std=c++14 -Xcudafe "--diag_suppress=1301" -c $< -o $@

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo -e "$(YELLOW)üßπ Cleaning...$(NC)"
	rm -f $(OBJECTS) $(TARGET)
	rm -rf ~/.cache/gstreamer-1.0/
	@echo -e "$(GREEN)‚úì Clean complete$(NC)"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ
install: $(TARGET)
	@echo -e "$(YELLOW)üì¶ Installing plugin...$(NC)"
	@mkdir -p ~/.local/share/gstreamer-1.0/plugins/
	@cp $(TARGET) ~/.local/share/gstreamer-1.0/plugins/
	@echo -e "$(GREEN)‚úì Plugin installed to ~/.local/share/gstreamer-1.0/plugins/$(NC)"
	@rm -rf ~/.cache/gstreamer-1.0/

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–≥–∏–Ω–∞
test-load: $(TARGET) install
	@echo -e "$(BLUE)üîç Testing plugin load...$(NC)"
	@export LD_LIBRARY_PATH=$(DS_PATH)/lib:$$LD_LIBRARY_PATH; \
	export GST_PLUGIN_PATH=~/.local/share/gstreamer-1.0/plugins:$$GST_PLUGIN_PATH; \
	gst-inspect-1.0 nvdsvirtualcam > /dev/null 2>&1 && \
		echo -e "$(GREEN)‚úì Plugin loads successfully$(NC)" || \
		(echo -e "$(RED)‚úó Plugin failed to load$(NC)" && \
		 echo -e "$(YELLOW)Run 'make debug' for details$(NC)")

# –û—Ç–ª–∞–¥–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
debug: $(TARGET) install
	@echo -e "$(YELLOW)üîç Debugging plugin load...$(NC)"
	export LD_LIBRARY_PATH=$(DS_PATH)/lib:$$LD_LIBRARY_PATH; \
	export GST_PLUGIN_PATH=~/.local/share/gstreamer-1.0/plugins:$$GST_PLUGIN_PATH; \
	GST_DEBUG=2 gst-inspect-1.0 nvdsvirtualcam 2>&1

# –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞
debug-verbose: $(TARGET) install
	@echo -e "$(YELLOW)üîç Verbose debugging...$(NC)"
	export LD_LIBRARY_PATH=$(DS_PATH)/lib:$$LD_LIBRARY_PATH; \
	export GST_PLUGIN_PATH=~/.local/share/gstreamer-1.0/plugins:$$GST_PLUGIN_PATH; \
	GST_DEBUG=*:4 gst-inspect-1.0 nvdsvirtualcam 2>&1 | grep -E "(ERROR|WARN|nvds)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
check-symbols: $(TARGET)
	@echo -e "$(BLUE)üìã Checking exported symbols...$(NC)"
	@nm -D $(TARGET) | grep "plugin_init" || echo -e "$(RED)Warning: plugin_init not found!$(NC)"
	@echo -e "$(BLUE)üìã Checking undefined symbols...$(NC)"
	@ldd -r $(TARGET) 2>&1 | grep undefined || echo -e "$(GREEN)No undefined symbols$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
check-libs: $(TARGET)
	@echo -e "$(BLUE)üìö Library dependencies:$(NC)"
	@ldd $(TARGET)
	@echo -e "$(BLUE)üìö Missing libraries:$(NC)"
	@ldd $(TARGET) | grep "not found" || echo -e "$(GREEN)All libraries found$(NC)"

# –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç
test: $(TARGET) install
	@echo -e "$(BLUE)üß™ Running quick test...$(NC)"
	export LD_LIBRARY_PATH=$(DS_PATH)/lib:$$LD_LIBRARY_PATH; \
	export GST_PLUGIN_PATH=~/.local/share/gstreamer-1.0/plugins:$$GST_PLUGIN_PATH; \
	gst-launch-1.0 --gst-plugin-path=~/.local/share/gstreamer-1.0/plugins \
		videotestsrc num-buffers=1 ! \
		video/x-raw,width=4096,height=2048 ! \
		nvvideoconvert ! 'video/x-raw(memory:NVMM),format=RGBA' ! \
		nvdsvirtualcam yaw=0 pitch=0 roll=0 fov=55 ! \
		fakesink 2>&1 | grep -E "(ERROR|WARNING)" || echo -e "$(GREEN)‚úì Test passed$(NC)"

# –ü–æ–º–æ—â—å
help:
	@echo -e "$(BLUE)nvdsvirtualcam Makefile$(NC)"
	@echo -e "$(YELLOW)Commands:$(NC)"
	@echo -e "  $(GREEN)make$(NC)              - Build the plugin"
	@echo -e "  $(GREEN)make clean$(NC)        - Clean build files"  
	@echo -e "  $(GREEN)make install$(NC)      - Install plugin locally"
	@echo -e "  $(GREEN)make test-load$(NC)    - Test if plugin loads"
	@echo -e "  $(GREEN)make debug$(NC)        - Debug plugin loading"
	@echo -e "  $(GREEN)make check-symbols$(NC) - Check exported symbols"
	@echo -e "  $(GREEN)make check-libs$(NC)   - Check library dependencies"
	@echo -e "  $(GREEN)make test$(NC)         - Run quick test"

.PHONY: all clean install test-load debug debug-verbose check-symbols check-libs test help check-deps