# Документация исправлений виртуальной камеры

## Обзор
Этот документ описывает ключевые исправления в GStreamer плагине виртуальной камеры для отслеживания мяча на панорамном видео футбола.

## Основные файлы
- `src/gstnvdsvirtualcam.cpp` - главный файл плагина с логикой границ
- `src/nvdsvirtualcam_config.h` - конфигурация границ панорамы
- `src/cuda_virtual_cam_kernel.cu` - CUDA ядро для проекции

---

## 1. Исправление формулы pitch (КРИТИЧНО!)

**Файл:** `gstnvdsvirtualcam.cpp`, строки 117-139

**Проблема:** Формула преобразования Y-координаты в pitch была инвертирована.

**Старая (НЕПРАВИЛЬНАЯ) формула:**
```cpp
*out_pitch = LAT_MIN - norm_y * (LAT_MIN - LAT_MAX);
```

**Новая (ПРАВИЛЬНАЯ) формула:**
```cpp
gfloat norm_y = y / (pano_h - 1);
*out_pitch = LAT_MAX - norm_y * (LAT_MAX - LAT_MIN);
```

**Объяснение:**
- y=0 (верх изображения) должен соответствовать LAT_MAX (+27°)
- y=pano_h-1 (низ изображения) должен соответствовать LAT_MIN (-27°)

---

## 2. Центрирование границ панорамы

**Файл:** `nvdsvirtualcam_config.h`, строки 21-22

**Изменение:**
```cpp
// Было:
constexpr float LAT_MIN = -32.0f;
constexpr float LAT_MAX = +22.0f;

// Стало:
constexpr float LAT_MIN = -27.0f;
constexpr float LAT_MAX = +27.0f;
```

**Результат:**
- Высота панорамы осталась 54° (LAT_MAX - LAT_MIN)
- Но теперь она отцентрирована симметрично: ±27°
- Камера стартует точно по центру панорамы

---

## 3. Коррекция для сферической геометрии (yaw factor)

**Файл:** `gstnvdsvirtualcam.cpp`, строки 1366-1393

**Проблема:**
Когда камера повёрнута по горизонтали (yaw ≠ 0), вертикальное движение создаёт более длинную дугу на сфере. Это приводило к выходу камеры за границы при повороте.

**Решение:**
```cpp
// Нормализуем yaw в диапазон [-1, 1]
gfloat yaw_normalized = (vcam->target_yaw - EFFECTIVE_LON_MIN) / (EFFECTIVE_LON_MAX - EFFECTIVE_LON_MIN);
yaw_normalized = (yaw_normalized - 0.5f) * 2.0f;

// Вычисляем коэффициент через косинус
gfloat yaw_factor = cosf(yaw_normalized * M_PI * 0.5f);
// cos(0) = 1.0 (центр), cos(±π/2) = 0.0 (края)

// ВАЖНО: Используем ДЕЛЕНИЕ, а не умножение!
gfloat corrected_half_fov_v = effective_half_fov_v / fmaxf(yaw_factor, 0.6f);
```

**Ключевые моменты:**
- Используется **деление**, а не умножение (при попытке умножения пользователь сказал "стало хуже")
- Минимум 0.6 предотвращает слишком сильное сужение границ

---

## 4. Ограничение (clamping) FOV - Предотвращение чёрных полос

**Файл:** `gstnvdsvirtualcam.cpp`, строки 1395-1425

**Проблема:**
При FOV=68° и позиции у края панорамы, `corrected_half_fov_v` мог превысить половину высоты панорамы (27°), делая границы невалидными:
```
pitch_min_safe = -27 + 30 = +3°
pitch_max_safe = +27 - 30 = -3°
→ pitch_min >= pitch_max (НЕВАЛИДНО!)
```

Это вызывало:
- Чёрные полосы сверху при максимальном зуме у верхнего края
- Чёрные полосы снизу при максимальном зуме у нижнего края
- Чёрные полосы по бокам при максимальном зуме у боковых краёв

**Решение:**

### Вертикальное ограничение:
```cpp
gfloat max_half_panorama_v = fminf(EFFECTIVE_LAT_MAX, -EFFECTIVE_LAT_MIN);  // 27°
corrected_half_fov_v = fminf(corrected_half_fov_v, max_half_panorama_v - 0.2f);
```
**Запас:** -0.2° (подобрано итеративно через тестирование пользователем)

### Горизонтальное ограничение:
```cpp
gfloat max_half_panorama_h = (EFFECTIVE_LON_MAX - EFFECTIVE_LON_MIN) / 2.0f;  // 90°
gfloat clamped_half_fov_h = fminf(effective_half_fov_h, max_half_panorama_h - 0.1f);
```
**Запас:** -0.1° (подобрано итеративно через тестирование пользователем)

**История подбора запасов:**
- Вертикальный: начали с -1.0° → -0.5° → **-0.2°** (финальное)
- Горизонтальный: начали с -0.5° → -0.2° → **-0.1°** (финальное)

Каждый шаг одобрялся пользователем после тестирования.

---

## 5. Коэффициенты сферической проекции

**Файл:** `gstnvdsvirtualcam.cpp`, строки 1340-1364

**Объяснение:**
На equirectangular (сферической) проекции FOV камеры не совпадает 1:1 с угловым покрытием панорамы.

### Вертикальный коэффициент:
```cpp
const gfloat SPHERICAL_FACTOR_V = PANORAMA_HEIGHT / MAX_FOV * 0.8;  // ≈ 0.635
```
- Панорама: 54° высоты
- Максимальный FOV: 68°
- Базовое соотношение: 54/68 ≈ 0.794
- Умножаем на 0.8 для баланса → ≈ 0.635
- **Результат:** FOV=68° реально покрывает ~43° панорамы (68 × 0.635)

### Горизонтальный коэффициент:
```cpp
const gfloat SPHERICAL_FACTOR_H = 0.63f;
```
- На экваторе (центр по вертикали) искажения меньше
- Коэффициент 0.63 подобран эмпирически (баланс свободы и безопасности)

---

## 6. Двухуровневая защита границ

**Файл:** `gstnvdsvirtualcam.cpp`, строки 1464-1483

**Логика:**
Применяем ограничения в **два уровня** для максимальной надёжности:

### Уровень 1: Абсолютные границы панорамы
```cpp
vcam->target_pitch = fmaxf(EFFECTIVE_LAT_MIN, fminf(EFFECTIVE_LAT_MAX, vcam->target_pitch));
vcam->target_yaw = fmaxf(EFFECTIVE_LON_MIN, fminf(EFFECTIVE_LON_MAX, vcam->target_yaw));
```
- Центр камеры **НИКОГДА** не выходит за границы панорамы

### Уровень 2: Безопасная зона (с учётом FOV)
```cpp
vcam->target_pitch = fmaxf(pitch_min_safe, fminf(pitch_max_safe, vcam->target_pitch));
vcam->target_yaw = fmaxf(yaw_min_safe, fminf(yaw_max_safe, vcam->target_yaw));
```
- Центр камеры ограничен так, чтобы **края камеры** не выходили за панораму
- Это предотвращает чёрные полосы

---

## 7. Fallback механизм для невалидных границ

**Файл:** `gstnvdsvirtualcam.cpp`, строки 1442-1462

**Проблема:**
Если границы пересеклись (min >= max), FOV слишком большой для текущей позиции.

**Решение:**
Мы **НЕ отключаем** ограничения, а наоборот делаем их **СТРОЖЕ**:

```cpp
if (pitch_min_safe >= pitch_max_safe) {
    gfloat center_pitch = (EFFECTIVE_LAT_MIN + EFFECTIVE_LAT_MAX) / 2.0f;
    pitch_min_safe = center_pitch - 2.0f;  // Узкий диапазон ±2°
    pitch_max_safe = center_pitch + 2.0f;
}
```

Это фиксирует камеру в центре с узким диапазоном ±2°, предотвращая застревание или выход за границы.

---

## 8. Функция сглаживания камеры

**Файл:** `gstnvdsvirtualcam.cpp`, строки 150-243

**Функция:** `smooth_camera_tracking()`

**Логика:**
Применяет exponential smoothing (lerp) для плавного движения:

```cpp
// Формула: new_value = current_value + (target - current) * smooth_factor
vcam->yaw += yaw_diff * vcam->smooth_factor;
vcam->pitch += pitch_diff * vcam->smooth_factor;
vcam->fov += fov_diff * vcam->smooth_factor;
```

**Параметры:**
- `smooth_factor` = 0.3 (по умолчанию): камера движется на 30% расстояния до цели каждый кадр
- `DEAD_ZONE` = 0.1°: игнорируем изменения < 0.1° для yaw/pitch
- `FOV_DEAD_ZONE` = 0.5°: игнорируем изменения < 0.5° для FOV

**Пример:**
```
Кадр 1: current=0°, target=10° → new = 0 + 10*0.3 = 3°
Кадр 2: current=3°, target=10° → new = 3 + 7*0.3 = 5.1°
Кадр 3: current=5.1°, target=10° → new = 5.1 + 4.9*0.3 = 6.57°
```

---

## 9. Функция слежения за мячом

**Файл:** `gstnvdsvirtualcam.cpp`, строки 1256-1378

**Функция:** `update_camera_from_ball()`

**Шаги:**
1. **Преобразование координат:** ball_x, ball_y → yaw, pitch
2. **Добавление смещения у края:**
   - Если мяч в пределах 300px от края → камера смещается в противоположную сторону
   - Горизонтальное смещение: ±8°
   - Вертикальное смещение: ±4°

**Цель смещения:**
- Мяч не прилипает к краю кадра
- Видно куда мяч движется (предсказание)

---

## Итоговый результат

### Что исправлено:
1. ✅ Инвертированная формула pitch
2. ✅ Центрирование границ панорамы (-27° до +27°)
3. ✅ Коррекция для сферической геометрии (yaw factor с делением)
4. ✅ Ограничение FOV для предотвращения чёрных полос (запасы -0.2° и -0.1°)
5. ✅ Двухуровневая защита границ (абсолютная + безопасная зона)
6. ✅ Fallback для невалидных границ (фиксация в центре)

### Параметры:
- Панорама: 5700×1900 px, -90° до +90° (горизонталь), -27° до +27° (вертикаль)
- FOV диапазон: 40° до 68°
- Сферические коэффициенты: 0.635 (вертикаль), 0.63 (горизонталь)
- Запасы для clamping: -0.2° (вертикаль), -0.1° (горизонталь)
- Smooth factor: 0.3 (по умолчанию)

### Поведение:
- В центре панорамы: полная свобода движения, нет чёрных полос
- У краёв панорамы: ограниченное движение, нет чёрных полос
- При максимальном зуме (FOV=68°): минимальные чёрные полосы только в крайних позициях
- При повороте камеры: вертикальные границы динамически сужаются (yaw factor)

---

## Быстрый поиск по коду

### Где найти ключевые исправления:

1. **Формула pitch:** `gstnvdsvirtualcam.cpp:117-139`
2. **Границы панорамы:** `nvdsvirtualcam_config.h:21-22`
3. **Yaw factor коррекция:** `gstnvdsvirtualcam.cpp:1366-1393`
4. **Clamping (ограничение):** `gstnvdsvirtualcam.cpp:1395-1425`
5. **Двухуровневая защита:** `gstnvdsvirtualcam.cpp:1464-1483`
6. **Сглаживание:** `gstnvdsvirtualcam.cpp:150-243`
7. **Слежение за мячом:** `gstnvdsvirtualcam.cpp:1256-1378`

---

## Примечания

- Все значения запасов (-0.2°, -0.1°) подобраны **итеративно через тестирование** пользователем
- Комментарии в коде **подробно объясняют** каждый шаг и проблемы, которые он решает
- Код максимально **задокументирован** для быстрого понимания и будущих изменений
