# Исправление границ виртуальной камеры

## Проблема

При использовании виртуальной камеры с разными значениями FOV появлялись **черные полосы** по краям изображения. Это происходило потому, что границы камеры были настроены неправильно и не соответствовали реальным размерам панорамы.

## Анализ

### Параметры панорамы
- **Размер**: 5700 × 1900 пикселей
- **Горизонтальное покрытие**: -90° до +90° (180°)
- **Вертикальное покрытие**: -32° до +22° (54°)

### FOV диапазон
- **Минимум**: 40°
- **Максимум**: 68°

### Свобода движения при разных FOV

| FOV  | Вертикальная свобода | Горизонтальная свобода |
|------|---------------------|----------------------|
| 40°  | 14.0°               | 108.9°              |
| 50°  | 4.0°                | 91.1°               |
| 60°  | -6.0° ⚠️            | 73.3°               |
| 68°  | -14.0° ⚠️           | 59.1°               |

**Проблема**: При FOV ≥ 60° вертикальный FOV **больше** высоты панорамы (54°)!

## Изменения в коде

### До исправления (НЕПРАВИЛЬНО)

В файле `gstnvdsvirtualcam.cpp` строки ~1302-1303:

```cpp
const gfloat EFFECTIVE_LAT_MIN_BASE = -30.0f;  // ❌ Не соответствует панораме
const gfloat EFFECTIVE_LAT_MAX_BASE = +40.0f;  // ❌ Не соответствует панораме
```

Строки ~1336-1337:
```cpp
const gfloat EFFECTIVE_LON_MIN = -105.0f;  // ❌ Шире панорамы
const gfloat EFFECTIVE_LON_MAX = +105.0f;  // ❌ Шире панорамы
```

### После исправления (ПРАВИЛЬНО)

Строки ~1302-1303:
```cpp
const gfloat EFFECTIVE_LAT_MIN_BASE = NvdsVirtualCamConfig::LAT_MIN;  // ✅ -32° (точная граница)
const gfloat EFFECTIVE_LAT_MAX_BASE = NvdsVirtualCamConfig::LAT_MAX;  // ✅ +22° (точная граница)
```

Строки ~1336-1337:
```cpp
const gfloat EFFECTIVE_LON_MIN = NvdsVirtualCamConfig::LON_MIN;  // ✅ -90° (точная граница)
const gfloat EFFECTIVE_LON_MAX = NvdsVirtualCamConfig::LON_MAX;  // ✅ +90° (точная граница)
```

## Как работает ограничение

Логика ограничения камеры (строки ~1326-1353):

```cpp
gfloat half_fov = vcam->target_fov / 2.0f;

// Проверка вертикали (PITCH)
if (vcam->target_pitch + half_fov > EFFECTIVE_LAT_MAX) {
    vcam->target_pitch = EFFECTIVE_LAT_MAX - half_fov;  // Отодвигаем камеру вниз
}
if (vcam->target_pitch - half_fov < EFFECTIVE_LAT_MIN) {
    vcam->target_pitch = EFFECTIVE_LAT_MIN + half_fov;  // Отодвигаем камеру вверх
}

// Проверка горизонтали (YAW)
gfloat horizontal_fov = vcam->target_fov * (16.0f / 9.0f);
gfloat half_fov_h = horizontal_fov / 2.0f;

if (vcam->target_yaw - half_fov_h < EFFECTIVE_LON_MIN) {
    vcam->target_yaw = EFFECTIVE_LON_MIN + half_fov_h;
}
if (vcam->target_yaw + half_fov_h > EFFECTIVE_LON_MAX) {
    vcam->target_yaw = EFFECTIVE_LON_MAX - half_fov_h;
}
```

### Принцип работы

1. **Вычисляем половину FOV** (vertical и horizontal)
2. **Проверяем границы**: если край камеры (center ± half_fov) выходит за панораму
3. **Автоматически корректируем** позицию камеры, отодвигая её от края

## Результат

✅ **Теперь при любом FOV (40° - 68°)**:
- Камера автоматически ограничивается краями панорамы
- Нет черных полос
- Эффективная свобода движения зависит от FOV:
  - При малом FOV (40°) - больше свободы
  - При большом FOV (68°) - меньше свободы, но камера центрируется автоматически

## Тестирование

Запустите скрипт для тестирования:

```bash
cd /home/nvidia/deep_cv_football/my_virt_cam
python3 test_virtual_camera_keyboard.py left.mp4 right.mp4
```

### Как проверить:

1. **Запустите скрипт** с клавиатурным управлением
2. **Увеличьте FOV** до максимума (клавиша `X` несколько раз)
3. **Попробуйте двигать мяч** в разные стороны (`W/A/S/D`)
4. **Проверьте**: не должно быть черных полос даже при движении по краям

### Ожидаемое поведение:

- При **FOV=40°**: большая свобода движения, камера может перемещаться по всей панораме
- При **FOV=68°**: камера автоматически центрируется, свобода движения ограничена (особенно по вертикали)
- **Никаких черных полос** при любом FOV и любой позиции

## Дополнительные скрипты

### Расчет границ
```bash
python3 calculate_safe_boundaries.py
```

Этот скрипт показывает математический расчет безопасных границ для любого FOV.

## Файлы изменены

1. `src/gstnvdsvirtualcam.cpp` - исправлены границы (строки 1302-1303, 1336-1337)
2. `calculate_safe_boundaries.py` - новый скрипт для анализа границ
3. `BOUNDARY_FIX_SUMMARY.md` - эта документация

## Перекомпиляция

После изменений в C++ коде нужно пересобрать плагин:

```bash
cd /home/nvidia/deep_cv_football/my_virt_cam
./rebuild.sh
```
