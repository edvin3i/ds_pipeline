# Логика ограничения границ панорамы

## Проблема

При вращении виртуальной камеры нужно гарантировать, что камера **не показывает область за пределами панорамы** (чёрные углы, артефакты).

## Решение: Динамические границы на основе FOV

### Основной принцип

**Чем больше FOV → тем меньше область движения камеры**

```
┌────────────────────────────────────────┐
│          ПАНОРАМА 5700x1900            │
│  ┌──────────────────────────────────┐  │
│  │                                  │  │ ← При FOV=40° (узкий)
│  │   Допустимая зона движения      │  │   камера может близко
│  │   камеры при МАЛОМ FOV           │  │   подходить к краям
│  │                                  │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ┌────────────────────────────┐        │
│  │  Допустимая зона при       │        │ ← При FOV=70° (широкий)
│  │  БОЛЬШОМ FOV               │        │   камера должна держаться
│  └────────────────────────────┘        │   дальше от краёв
└────────────────────────────────────────┘
```

---

## Формула расчёта границ

### Исходные данные:

**Границы панорамы** (из конфига):
- `LON_MIN = -90°`  (левый край)
- `LON_MAX = +90°`  (правый край)
- `LAT_MIN = -32°`  (нижний край)
- `LAT_MAX = +22°`  (верхний край)

**Текущий FOV камеры:**
- `fov` = 40-70° (вертикальный угол обзора)

**Aspect ratio выхода:**
- `aspect = 1.777` (для 1920x1080, т.е. 16:9)

### Вычисление половины FOV:

```cpp
half_fov_h = fov × aspect × 0.5  // Половина FOV по горизонтали
half_fov_v = fov × 0.5           // Половина FOV по вертикали
```

**Пример при FOV = 60°:**
- `half_fov_h = 60 × 1.777 × 0.5 = 53.3°`
- `half_fov_v = 60 × 0.5 = 30°`

### Вычисление допустимых границ:

```cpp
const float MARGIN = 1.0°;  // Технический запас

yaw_min = LON_MIN + half_fov_h + MARGIN
yaw_max = LON_MAX - half_fov_h - MARGIN
pitch_min = LAT_MIN + half_fov_v + MARGIN
pitch_max = LAT_MAX - half_fov_v + MARGIN
```

---

## Примеры расчёта для разных FOV

### FOV = 40° (узкий угол - близкий план):

```
half_fov_h = 40 × 1.777 × 0.5 = 35.5°
half_fov_v = 40 × 0.5 = 20°

Границы движения камеры:
  yaw:   [-90 + 35.5 + 1] до [+90 - 35.5 - 1] = [-53.5°, +53.5°]
  pitch: [-32 + 20 + 1]   до [+22 - 20 - 1]   = [-11°, +1°]

Диапазон движения: 107° по yaw, 12° по pitch
```

### FOV = 55° (средний угол):

```
half_fov_h = 55 × 1.777 × 0.5 = 48.9°
half_fov_v = 55 × 0.5 = 27.5°

Границы движения камеры:
  yaw:   [-90 + 48.9 + 1] до [+90 - 48.9 - 1] = [-40.1°, +40.1°]
  pitch: [-32 + 27.5 + 1] до [+22 - 27.5 - 1] = [-3.5°, -6.5°] ⚠️

Диапазон движения: 80.2° по yaw, ЗАБЛОКИРОВАН по pitch!
```

⚠️ **ВАЖНО:** При FOV > 54° вертикальное движение сильно ограничено или невозможно!

### FOV = 70° (широкий угол - максимум):

```
half_fov_h = 70 × 1.777 × 0.5 = 62.2°
half_fov_v = 70 × 0.5 = 35°

Границы движения камеры:
  yaw:   [-90 + 62.2 + 1] до [+90 - 62.2 - 1] = [-26.8°, +26.8°]
  pitch: [-32 + 35 + 1]   до [+22 - 35 - 1]   = [+4°, -14°] ⚠️

Диапазон движения: 53.6° по yaw, ЗАБЛОКИРОВАН по pitch!
```

⚠️ **При FOV=70° камера ВООБЩЕ НЕ МОЖЕТ двигаться по pitch!**

---

## Таблица границ движения

| FOV | half_fov_h | half_fov_v | Yaw диапазон | Pitch диапазон | Комментарий |
|-----|------------|------------|--------------|----------------|-------------|
| 40° | 35.5°      | 20°        | 107°         | 12°            | ✅ Полная свобода |
| 45° | 40.0°      | 22.5°      | 98°          | 7.5°           | ✅ Хорошо |
| 50° | 44.4°      | 25°        | 89.2°        | 3°             | ⚠️ Мало по pitch |
| 55° | 48.9°      | 27.5°      | 80.2°        | 0° (блок)      | ⚠️ Pitch заблокирован |
| 60° | 53.3°      | 30°        | 71.4°        | -16° (блок)    | ❌ Pitch заблокирован |
| 65° | 57.8°      | 32.5°      | 62.4°        | -21° (блок)    | ❌ Pitch заблокирован |
| 70° | 62.2°      | 35°        | 53.6°        | -28° (блок)    | ❌ Pitch заблокирован |

**Критическая точка:** FOV ≈ 54° - после этого вертикальное движение становится невозможным!

---

## Поведение при разных FOV

### Малый FOV (40-50°) - рекомендуется

**Преимущества:**
- ✅ Камера свободно двигается по yaw и pitch
- ✅ Можно следить за мячом по всему полю
- ✅ Нет проблем с границами

**Недостатки:**
- Узкий угол обзора
- Видно меньше поля

### Средний FOV (50-55°) - осторожно

**Преимущества:**
- Хороший баланс обзора и свободы движения
- Ещё возможно небольшое вертикальное движение

**Недостатки:**
- ⚠️ Очень мало места для pitch
- Камера "упирается" в потолок/пол

### Большой FOV (55-70°) - проблематично

**Преимущества:**
- Широкий обзор поля
- Видно много деталей

**Недостатки:**
- ❌ Pitch ЗАБЛОКИРОВАН полностью
- ❌ Камера может двигаться только по yaw
- ❌ Невозможно следить за мячом если он двигается вверх/вниз

---

## Рекомендации

### Для автослежения за мячом:

**Оптимальный диапазон FOV: 40-50°**
- Камера сохраняет свободу движения
- Можно следить за мячом в любой точке поля
- Нет проблем с границами панорамы

### Для статичного просмотра:

**Можно использовать: 50-70°**
- Широкий обзор
- Камера фиксирована на определённой точке
- Не требуется вертикальное движение

### Настройка MARGIN:

В коде можно изменить технический запас:
```cpp
const float MARGIN = 1.0f;  // 0.5-2.0° рекомендуется
```

- **MARGIN = 0.5°** - минимальный запас, больше свободы
- **MARGIN = 1.0°** - рекомендуется (текущее значение)
- **MARGIN = 2.0°** - консервативно, гарантирует отсутствие артефактов

---

## Логирование границ

При изменении FOV на 5° или более, плагин выводит информацию о границах:

```
INFO: FOV=60.0° → Границы: yaw[-26.7, 26.7], pitch[-2.0, -8.0]
```

Это помогает понять, почему камера "упирается" в границы при определённом FOV.

---

## Код реализации

**Файл:** `src/gstnvdsvirtualcam.cpp`

**Функция:** `apply_edge_safe_limits()` (строка ~186-220)

**Вызывается:** В конце `smooth_camera_tracking()` на каждом кадре

---

## Итоговая логика

1. **Каждый кадр:**
   - Рассчитывается `target_fov` на основе размера мяча
   - Применяется сглаживание к `vcam->fov`
   - `vcam->fov` ограничивается 40-70°

2. **После сглаживания:**
   - Вычисляются `half_fov_h` и `half_fov_v`
   - Рассчитываются допустимые границы движения
   - `yaw`, `pitch`, `target_yaw`, `target_pitch` обрезаются

3. **Результат:**
   - Камера НИКОГДА не выходит за границы панорамы
   - Чем больше FOV, тем меньше свобода движения
   - При FOV > 54° вертикальное движение блокируется

---

✅ **Система активирована и работает на каждом кадре!**
