# Логика граничного контроля v2 (исправленная)

## Проблема с предыдущей версией

Старая логика **блокировала pitch** если FOV > высота панорамы (54°).
Но на практике при FOV=70° панорама **нормально влезает**!

**Причина ошибки:** Неправильное понимание того как FOV взаимодействует с границами.

---

## Правильная логика (текущая реализация)

### Принцип работы

**Границы движения камеры = динамически рассчитываются на основе текущего FOV**

```
При FOV=40° (узкий) → большая свобода движения
При FOV=70° (широкий) → малая свобода движения
```

### Формулы

```cpp
// 1. Вычисляем половину FOV
half_fov_h = fov × 1.777 × 0.5  // Горизонталь (aspect 16:9)
half_fov_v = fov × 0.5           // Вертикаль

// 2. Рассчитываем границы движения
yaw_min = LON_MIN + half_fov_h + MARGIN    // -90° + half_fov + 0.5°
yaw_max = LON_MAX - half_fov_h - MARGIN    // +90° - half_fov - 0.5°

pitch_min = LAT_MIN + half_fov_v + MARGIN  // -32° + half_fov + 0.5°
pitch_max = LAT_MAX - half_fov_v - MARGIN  // +22° - half_fov - 0.5°

// 3. Если границы "схлопнулись" (min > max)
//    Это означает что FOV больше чем панорама
//    Оставляем минимальный диапазон ±1° вокруг центра
if (pitch_min > pitch_max) {
    center = (LAT_MIN + LAT_MAX) / 2  // -5°
    pitch_min = center - 1.0°  // -6°
    pitch_max = center + 1.0°  // -4°
}

// То же самое для yaw (но это маловероятно т.к. панорама широкая)

// 4. Применяем CLAMP
yaw = CLAMP(yaw, yaw_min, yaw_max)
pitch = CLAMP(pitch, pitch_min, pitch_max)
```

---

## Примеры расчётов

### FOV = 40° (узкий угол)

```
half_fov_h = 40 × 1.777 × 0.5 = 35.5°
half_fov_v = 40 × 0.5 = 20°

yaw_min = -90 + 35.5 + 0.5 = -54.0°
yaw_max = +90 - 35.5 - 0.5 = +54.0°  → диапазон 108°

pitch_min = -32 + 20 + 0.5 = -11.5°
pitch_max = +22 - 20 - 0.5 = +1.5°   → диапазон 13°

✅ Камера свободно двигается
```

### FOV = 60° (средний угол)

```
half_fov_h = 60 × 1.777 × 0.5 = 53.3°
half_fov_v = 60 × 0.5 = 30°

yaw_min = -90 + 53.3 + 0.5 = -36.2°
yaw_max = +90 - 53.3 - 0.5 = +36.2°  → диапазон 72.4°

pitch_min = -32 + 30 + 0.5 = -1.5°
pitch_max = +22 - 30 - 0.5 = -8.5°   → min > max! ❌

Схлопывание! Применяем fallback:
pitch_min = -5 - 1 = -6°
pitch_max = -5 + 1 = -4°  → диапазон 2° (вокруг центра)

⚠️ Pitch сильно ограничен, но НЕ заблокирован
```

### FOV = 70° (широкий угол)

```
half_fov_h = 70 × 1.777 × 0.5 = 62.2°
half_fov_v = 70 × 0.5 = 35°

yaw_min = -90 + 62.2 + 0.5 = -27.3°
yaw_max = +90 - 62.2 - 0.5 = +27.3°  → диапазон 54.6°

pitch_min = -32 + 35 + 0.5 = +3.5°
pitch_max = +22 - 35 - 0.5 = -13.5°  → min > max! ❌

Схлопывание! Применяем fallback:
pitch_min = -5 - 1 = -6°
pitch_max = -5 + 1 = -4°  → диапазон 2° (вокруг центра)

⚠️ Pitch почти зафиксирован (±1°), yaw работает нормально
```

---

## Таблица поведения

| FOV | Yaw диапазон | Pitch диапазон | Вертикальное движение |
|-----|-------------|----------------|----------------------|
| 40° | 108°        | 13°            | ✅ Полная свобода |
| 50° | 89°         | 3°             | ⚠️ Ограничено |
| 55° | 80°         | 2° (fallback)  | ⚠️ Почти нет |
| 60° | 72°         | 2° (fallback)  | ⚠️ Минимально |
| 65° | 64°         | 2° (fallback)  | ⚠️ Минимально |
| 70° | 55°         | 2° (fallback)  | ⚠️ Минимально |

---

## Ключевые отличия от старой логики

### Старая логика ❌
```cpp
if (fov > pano_height) {
    pitch = CENTER;  // Жёсткая блокировка!
    pitch НЕ МОЖЕТ двигаться вообще
}
```

### Новая логика ✅
```cpp
// Всегда рассчитываем границы динамически
pitch_min = LAT_MIN + half_fov_v + MARGIN
pitch_max = LAT_MAX - half_fov_v - MARGIN

// Если границы инвертированы - оставляем небольшой диапазон
if (pitch_min > pitch_max) {
    pitch_min = center - 1°
    pitch_max = center + 1°
}

// Камера МОЖЕТ двигаться в пределах [pitch_min, pitch_max]
```

---

## Почему это работает

### При FOV=70° панорама "впритык" но влезает:

1. **Камера не обязательно в центре панорамы**
   - Может быть pitch = -4° или -6° (±1° вокруг -5°)
   - При разных pitch камера "видит" разные части панорамы

2. **MARGIN даёт небольшой запас**
   - MARGIN = 0.5° создаёт технический запас от краёв
   - Это позволяет избежать чёрных пикселей на границах

3. **FOV не обязательно точно 70°**
   - Из-за сглаживания реальный FOV может быть 69.5-70°
   - Небольшие отклонения не критичны

4. **Панорама может быть чуть больше заявленной**
   - Возможно реальные границы -33° до +23° (не -32° до +22°)
   - 1-2° запаса по краям панорамы

---

## Настройка MARGIN

**Текущее значение:** `MARGIN = 0.5°`

### Влияние MARGIN:

| MARGIN | Свобода движения | Безопасность краёв |
|--------|-----------------|-------------------|
| 0.0°   | Максимальная    | Возможны артефакты |
| 0.5°   | Хорошая         | Минимальные артефакты |
| 1.0°   | Средняя         | Гарантированно без артефактов |
| 2.0°   | Малая           | Очень консервативно |

**Рекомендация:** Оставить 0.5° если нет проблем с артефактами.

---

## Проверка в логах

При изменении FOV на 5° или больше выводится:

```
INFO: FOV=70.0° → Границы: yaw[-27.3, 27.3], pitch[-6.0, -4.0]
INFO: FOV=50.0° → Границы: yaw[-44.5, 44.5], pitch[-11.5, 1.5]
```

Если видите `pitch[-6.0, -4.0]` - это означает fallback (схлопывание границ).

---

## Будущие улучшения (опционально)

### 1. Адаптивный MARGIN на основе FOV
```cpp
// Чем больше FOV → тем больше запас нужен
float adaptive_margin = 0.3f + (fov - 40.0f) / 100.0f;
// При FOV=40° → 0.3°
// При FOV=70° → 0.6°
```

### 2. Проверка реальных границ панорамы
```cpp
// Если панорама на самом деле больше - обновить константы
constexpr float LAT_MIN = -35.0f;  // Вместо -32.0f
constexpr float LAT_MAX = +25.0f;  // Вместо +22.0f
```

### 3. Динамический fallback диапазон
```cpp
// Вместо фиксированного ±1° использовать процент от FOV
float fallback_range = fov * 0.02f;  // 2% от FOV
pitch_min = center - fallback_range;
pitch_max = center + fallback_range;
```

---

## Итог

✅ **Новая логика:**
- НЕ блокирует pitch жёстко
- Оставляет небольшой диапазон движения даже при FOV=70°
- Работает плавно при любых FOV от 40° до 70°
- Не создаёт чёрные области на краях

✅ **Результат:**
Камера может работать при FOV=70° с минимальным вертикальным движением (±1°) но без полной блокировки.
