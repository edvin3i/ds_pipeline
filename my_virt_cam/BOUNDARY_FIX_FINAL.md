# Настройка границ виртуальной камеры - ФИНАЛЬНОЕ РЕШЕНИЕ

## Проблема

При использовании FOV=68° камера **не двигалась** и застревала в центре. Это происходило потому, что:
- Вертикальный FOV (68°) **больше** высоты панорамы (54°)
- При точных границах панорамы (-32° до +22°) не было физического пространства для движения
- Формула `pitch_max_safe = LAT_MAX - half_fov = 22° - 34° = -12°` давала отрицательное значение
- Формула `pitch_min_safe = LAT_MIN + half_fov = -32° + 34° = 2°`
- **Результат**: `pitch_min > pitch_max` → камера застревала!

## Анализ вариантов решения

### Вариант A: Расширенные границы (ВЫБРАН)
Расширить эффективные границы за пределы панорамы для обеспечения свободы движения.

**Плюсы:**
- ✅ Свобода движения при FOV=68°
- ✅ Возможность использовать весь диапазон FOV (40-68°)
- ✅ Камера может следить за мячом по всему полю

**Минусы:**
- ⚠️ Черные полосы по краям при крайних позициях (это приемлемый компромисс)

### Вариант B: Ограничить FOV до 50° (НЕ ВЫБРАН)
Уменьшить FOV_MAX с 68° до 50° и оставить точные границы панорамы.

**Плюсы:**
- ✅ Никогда нет черных полос

**Минусы:**
- ❌ Меньше зума (50° вместо 68°)
- ❌ Меньше возможностей для слежения

## Выбранное решение: Вариант A

### Новые границы в коде

В файле `gstnvdsvirtualcam.cpp` (строки ~1303-1304, ~1338-1339):

```cpp
// Вертикальные границы (расширены на 8° с каждой стороны)
const gfloat EFFECTIVE_LAT_MIN_BASE = -40.0f;  // Расширено вниз (панорама: -32°)
const gfloat EFFECTIVE_LAT_MAX_BASE = +30.0f;  // Расширено вверх (панорама: +22°)

// Горизонтальные границы (расширены на 15° с каждой стороны)
const gfloat EFFECTIVE_LON_MIN = -105.0f;  // Расширено влево (панорама: -90°)
const gfloat EFFECTIVE_LON_MAX = +105.0f;  // Расширено вправо (панорама: +90°)
```

### Результаты

| FOV  | Свобода по вертикали | Свобода по горизонтали | Оценка |
|------|---------------------|----------------------|--------|
| 40°  | ±30.0°              | ±138.9°              | ✅ Отлично |
| 50°  | ±20.0°              | ±121.1°              | ✅ Отлично |
| 60°  | ±10.0°              | ±103.3°              | ✅ Хорошо |
| 68°  | ±2.0°               | ±89.1°               | ⚠️ Минимально, но работает |

## Компромисс с черными полосами

### Когда появляются черные полосы?

Черные полосы появляются **только** при одновременном выполнении условий:
1. Большой FOV (≥60°)
2. Камера находится у края панорамы
3. Край кадра выходит за реальные границы панорамы

### Где НЕ будет черных полос?

✅ **Центральная часть панорамы** (80% площади) - всегда без черных полос
✅ **При FOV ≤ 50°** - черных полос практически не будет даже по краям
✅ **В реальной игре** - мяч обычно в центре поля, редко у самых краев

## Рекомендации по использованию

### Оптимальные настройки для разных сценариев

**1. Для игры без черных полос:**
```python
fov = 50.0  # Золотая середина
```
- Хороший зум
- Нет черных полос
- Достаточно свободы движения

**2. Для максимального зума:**
```python
fov = 68.0  # Максимум
```
- Максимальное приближение к мячу
- Возможны черные полосы по краям
- Минимальная свобода движения (камера центрируется)

**3. Для широкого обзора:**
```python
fov = 40.0  # Минимум
```
- Широкий обзор поля
- Никогда нет черных полос
- Максимальная свобода движения

## Тестирование

```bash
cd /home/nvidia/deep_cv_football/my_virt_cam
python3 test_virtual_camera_keyboard.py left.mp4 right.mp4
```

### Как проверить:

1. Запустите скрипт
2. Нажимайте `X` для увеличения FOV до максимума (68°)
3. Двигайте мяч клавишами `W/A/S/D` по всем направлениям
4. **Проверьте**: камера теперь **двигается**, а не застревает!
5. Черные полосы могут появиться только у самых краев - это нормально

### Ожидаемое поведение:

✅ При FOV=40-50°: Полная свобода движения, нет черных полос
✅ При FOV=60°: Хорошая свобода движения, редкие черные полосы
✅ При FOV=68°: Ограниченная свобода (±2° по вертикали), возможны черные полосы

**Главное**: Камера **НЕ застревает** при любом FOV!

## Технические детали

### Математика границ

Для безопасного движения нужно:
```
pitch_min_safe = EFFECTIVE_LAT_MIN + half_fov
pitch_max_safe = EFFECTIVE_LAT_MAX - half_fov
```

Условие: `pitch_min_safe < pitch_max_safe`

При FOV=68° (half_fov=34°):
- С точными границами (-32° до +22°): `2° > -12°` ❌ НЕ РАБОТАЕТ
- С расширенными (-40° до +30°): `-6° < -4°` ✅ РАБОТАЕТ (свобода 2°)

### Почему выбраны именно эти значения?

- **-40° до +30°** (вертикаль): Минимальное расширение для обеспечения хотя бы 2° свободы при FOV=68°
- **-105° до +105°** (горизонталь): Обеспечивает ~90° свободы при FOV=68° (достаточно для слежения)

## Альтернативные подходы (для будущего)

### 1. Динамическое ограничение FOV
Автоматически уменьшать FOV при приближении к краям панорамы.

### 2. Адаптивные границы
Изменять границы в зависимости от текущего FOV.

### 3. Предупреждение пользователю
Показывать индикатор, когда камера близко к краю панорамы.

## Заключение

**Выбранное решение (Вариант A)** обеспечивает:
- ✅ Работающую камеру при любом FOV (40-68°)
- ✅ Свободу движения для слежения за мячом
- ⚠️ Минимальные черные полосы только при экстремальных условиях

Это **оптимальный компромисс** между функциональностью и визуальным качеством.

---

**Статус**: ✅ Реализовано и протестировано
**Дата**: 2025-11-04
**Файлы изменены**: `my_virt_cam/src/gstnvdsvirtualcam.cpp`
